package com.lureclub.points.api.admin;

import com.lureclub.points.entity.announcement.vo.request.AnnouncementCreateVo;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementUpdateVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员公告管理API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员公告管理接口", description = "管理员公告管理相关接口")
@RequestMapping("/api/admin/announcement")
public interface AdminAnnouncementApi {

    /**
     * 获取所有公告（管理员）
     *
     * @return 公告列表
     */
    @Operation(summary = "获取所有公告", description = "管理员获取所有公告列表")
    @GetMapping("")
    ApiResponse<List<AnnouncementVo>> getAllAnnouncements();

    /**
     * 创建公告
     *
     * @param createVo 公告信息
     * @return 创建结果
     */
    @Operation(summary = "创建公告", description = "管理员创建新公告")
    @PostMapping("")
    ApiResponse<AnnouncementVo> createAnnouncement(@Valid @RequestBody AnnouncementCreateVo createVo);

    /**
     * 更新公告
     *
     * @param id 公告ID
     * @param updateVo 更新信息
     * @return 更新结果
     */
    @Operation(summary = "更新公告", description = "管理员更新公告信息")
    @PutMapping("/{id}")
    ApiResponse<AnnouncementVo> updateAnnouncement(@Parameter(description = "公告ID") @PathVariable Long id,
                                                   @Valid @RequestBody AnnouncementUpdateVo updateVo);

    /**
     * 删除公告
     *
     * @param id 公告ID
     * @return 删除结果
     */
    @Operation(summary = "删除公告", description = "管理员删除公告")
    @DeleteMapping("/{id}")
    ApiResponse<String> deleteAnnouncement(@Parameter(description = "公告ID") @PathVariable Long id);

}


package com.lureclub.points.api.admin;

import com.lureclub.points.entity.admin.vo.request.AdminLoginVo;
import com.lureclub.points.entity.admin.vo.request.AdminCreateVo;
import com.lureclub.points.entity.admin.vo.response.AdminVo;
import com.lureclub.points.entity.admin.vo.response.LoginVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

/**
 * 管理员认证API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员认证接口", description = "管理员登录、管理相关接口")
@RequestMapping("/api/admin/auth")
public interface AdminAuthApi {

    /**
     * 管理员登录
     *
     * @param loginVo 登录信息
     * @return 登录结果
     */
    @Operation(summary = "管理员登录", description = "管理员使用用户名和密码登录")
    @PostMapping("/login")
    ApiResponse<LoginVo> login(@Valid @RequestBody AdminLoginVo loginVo);

    /**
     * 获取当前管理员信息
     *
     * @return 管理员信息
     */
    @Operation(summary = "获取当前管理员信息", description = "根据token获取当前登录管理员的信息")
    @GetMapping("/current")
    ApiResponse<AdminVo> getCurrentAdmin();

    /**
     * 添加管理员
     *
     * @param createVo 管理员信息
     * @return 创建结果
     */
    @Operation(summary = "添加管理员", description = "预留接口增加管理员")
    @PostMapping("/create")
    ApiResponse<AdminVo> createAdmin(@Valid @RequestBody AdminCreateVo createVo);

    /**
     * 管理员登出
     *
     * @return 登出结果
     */
    @Operation(summary = "管理员登出", description = "管理员登出系统")
    @PostMapping("/logout")
    ApiResponse<String> logout();

}


package com.lureclub.points.api.admin;

import com.lureclub.points.entity.message.vo.request.MessageReplyVo;
import com.lureclub.points.entity.message.vo.response.MessageVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员留言管理API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员留言管理接口", description = "管理员留言管理相关接口")
@RequestMapping("/api/admin/message")
public interface AdminMessageApi {

    /**
     * 获取所有留言（管理员）
     *
     * @return 留言列表
     */
    @Operation(summary = "获取所有留言", description = "管理员获取所有留言列表")
    @GetMapping("")
    ApiResponse<List<MessageVo>> getAllMessages();

    /**
     * 回复留言
     *
     * @param messageId 留言ID
     * @param replyVo 回复内容
     * @return 回复结果
     */
    @Operation(summary = "回复留言", description = "管理员回复用户留言")
    @PostMapping("/{messageId}/reply")
    ApiResponse<MessageVo> replyMessage(@Parameter(description = "留言ID") @PathVariable Long messageId,
                                        @Valid @RequestBody MessageReplyVo replyVo);

    /**
     * 设置留言可见性
     *
     * @param messageId 留言ID
     * @param isVisible 是否可见
     * @return 设置结果
     */
    @Operation(summary = "设置留言可见性", description = "管理员设置留言是否公开可见")
    @PutMapping("/{messageId}/visibility")
    ApiResponse<MessageVo> setMessageVisibility(@Parameter(description = "留言ID") @PathVariable Long messageId,
                                                @Parameter(description = "是否可见") @RequestParam Boolean isVisible);

}


package com.lureclub.points.api.admin;

import com.lureclub.points.entity.points.vo.request.PointsAddVo;
import com.lureclub.points.entity.points.vo.request.PointsDeductVo;
import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员积分管理API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员积分管理接口", description = "管理员积分管理相关接口")
@RequestMapping("/api/admin/points")
public interface AdminPointsApi {

    /**
     * 获取所有用户积分数据
     *
     * @return 所有用户积分列表
     */
    @Operation(summary = "获取所有用户积分", description = "获取所有用户的积分数据及详细历史积分")
    @GetMapping("/all")
    ApiResponse<List<PointsVo>> getAllUserPoints();

    /**
     * 搜索单个用户积分数据
     *
     * @param userId 用户ID
     * @return 用户积分信息
     */
    @Operation(summary = "搜索用户积分", description = "根据用户ID搜索单个用户积分数据及详细历史积分")
    @GetMapping("/user/{userId}")
    ApiResponse<PointsVo> getUserPointsById(@Parameter(description = "用户ID") @PathVariable Long userId);

    /**
     * 获取用户积分历史
     *
     * @param userId 用户ID
     * @return 用户积分历史列表
     */
    @Operation(summary = "获取用户积分历史", description = "获取指定用户的详细积分历史记录")
    @GetMapping("/history/{userId}")
    ApiResponse<List<PointsHistoryVo>> getUserPointsHistory(@Parameter(description = "用户ID") @PathVariable Long userId);

    /**
     * 录入用户积分
     *
     * @param pointsAddVo 积分录入信息
     * @return 操作结果
     */
    @Operation(summary = "录入用户积分", description = "管理员录入用户当日获得的积分")
    @PostMapping("/add")
    ApiResponse<PointsVo> addUserPoints(@Valid @RequestBody PointsAddVo pointsAddVo);

    /**
     * 抵扣用户积分
     *
     * @param pointsDeductVo 积分抵扣信息
     * @return 操作结果
     */
    @Operation(summary = "抵扣用户积分", description = "管理员抵扣用户有效积分（用于门票抵扣等）")
    @PostMapping("/deduct")
    ApiResponse<PointsVo> deductUserPoints(@Valid @RequestBody PointsDeductVo pointsDeductVo);

}


package com.lureclub.points.api.admin;

import com.lureclub.points.entity.prize.vo.request.PrizeCreateVo;
import com.lureclub.points.entity.prize.vo.request.PrizeUpdateVo;
import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员奖品管理API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员奖品管理接口", description = "管理员奖品管理相关接口")
@RequestMapping("/api/admin/prize")
public interface AdminPrizeApi {

    /**
     * 获取所有奖品（管理员）
     *
     * @return 奖品列表
     */
    @Operation(summary = "获取所有奖品", description = "管理员获取所有奖品列表")
    @GetMapping("")
    ApiResponse<List<PrizeVo>> getAllPrizes();

    /**
     * 创建奖品（含图片上传）
     *
     * @param createVo 奖品信息
     * @param imageFile 奖品图片
     * @return 创建结果
     */
    @Operation(summary = "创建奖品", description = "管理员创建新奖品，可上传图片")
    @PostMapping("")
    ApiResponse<PrizeVo> createPrize(@Valid @ModelAttribute PrizeCreateVo createVo,
                                     @Parameter(description = "奖品图片") @RequestParam(required = false) MultipartFile imageFile);

    /**
     * 更新奖品（含图片上传）
     *
     * @param id 奖品ID
     * @param updateVo 更新信息
     * @param imageFile 奖品图片（可选）
     * @return 更新结果
     */
    @Operation(summary = "更新奖品", description = "管理员更新奖品信息，可更新图片")
    @PutMapping("/{id}")
    ApiResponse<PrizeVo> updatePrize(@Parameter(description = "奖品ID") @PathVariable Long id,
                                     @Valid @ModelAttribute PrizeUpdateVo updateVo,
                                     @Parameter(description = "奖品图片") @RequestParam(required = false) MultipartFile imageFile);

    /**
     * 删除奖品
     *
     * @param id 奖品ID
     * @return 删除结果
     */
    @Operation(summary = "删除奖品", description = "管理员删除奖品")
    @DeleteMapping("/{id}")
    ApiResponse<String> deletePrize(@Parameter(description = "奖品ID") @PathVariable Long id);

}

package com.lureclub.points.api.admin;

import com.lureclub.points.entity.ranking.vo.response.RankingItemVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 管理员排行榜API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员排行榜接口", description = "管理员查看排行榜相关接口")
@RequestMapping("/api/admin/ranking")
public interface AdminRankingApi {

    /**
     * 获取当日排行榜
     *
     * @return 当日排行榜
     */
    @Operation(summary = "获取当日排行榜", description = "管理员查看当日排行榜")
    @GetMapping("/daily")
    ApiResponse<List<RankingItemVo>> getDailyRanking();

    /**
     * 获取本周排行榜
     *
     * @return 本周排行榜
     */
    @Operation(summary = "获取本周排行榜", description = "管理员查看本周排行榜")
    @GetMapping("/weekly")
    ApiResponse<List<RankingItemVo>> getWeeklyRanking();

    /**
     * 获取总排行榜
     *
     * @return 总排行榜
     */
    @Operation(summary = "获取总排行榜", description = "管理员查看总排行榜")
    @GetMapping("/total")
    ApiResponse<List<RankingItemVo>> getTotalRanking();

}

package com.lureclub.points.api.admin;

import com.lureclub.points.entity.user.vo.request.UserCreateVo;
import com.lureclub.points.entity.user.vo.request.UserUpdateVo;
import com.lureclub.points.entity.user.vo.request.UserSearchVo;
import com.lureclub.points.entity.user.vo.response.UserVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员用户管理API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "管理员用户管理接口", description = "管理员用户管理相关接口")
@RequestMapping("/api/admin/user")
public interface AdminUserApi {

    /**
     * 获取所有用户
     *
     * @return 用户列表
     */
    @Operation(summary = "获取所有用户", description = "获取所有用户列表")
    @GetMapping("/all")
    ApiResponse<List<UserVo>> getAllUsers();

    /**
     * 搜索用户
     *
     * @param searchVo 搜索条件
     * @return 用户列表
     */
    @Operation(summary = "搜索用户", description = "根据条件搜索用户")
    @PostMapping("/search")
    ApiResponse<List<UserVo>> searchUsers(@Valid @RequestBody UserSearchVo searchVo);

    /**
     * 创建用户
     *
     * @param createVo 用户信息
     * @return 创建结果
     */
    @Operation(summary = "创建用户", description = "管理员创建新用户")
    @PostMapping("")
    ApiResponse<UserVo> createUser(@Valid @RequestBody UserCreateVo createVo);

    /**
     * 更新用户信息
     *
     * @param userId 用户ID
     * @param updateVo 更新信息
     * @return 更新结果
     */
    @Operation(summary = "更新用户", description = "管理员更新用户信息")
    @PutMapping("/{userId}")
    ApiResponse<UserVo> updateUser(@Parameter(description = "用户ID") @PathVariable Long userId,
                                   @Valid @RequestBody UserUpdateVo updateVo);

    /**
     * 删除用户
     *
     * @param userId 用户ID
     * @return 删除结果
     */
    @Operation(summary = "删除用户", description = "管理员删除用户")
    @DeleteMapping("/{userId}")
    ApiResponse<String> deleteUser(@Parameter(description = "用户ID") @PathVariable Long userId);

}

package com.lureclub.points.api.user;

import com.lureclub.points.entity.announcement.vo.request.AnnouncementSearchVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementListVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 用户公告API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "用户公告接口", description = "用户查看公告相关接口")
@RequestMapping("/api/user/announcement")
public interface UserAnnouncementApi {

    /**
     * 获取所有公告内容
     *
     * @return 公告列表
     */
    @Operation(summary = "获取所有公告", description = "获取所有公告内容，按发布日期倒序排列")
    @GetMapping("")
    ApiResponse<List<AnnouncementListVo>> getAllAnnouncements();

    /**
     * 根据日期搜索公告
     *
     * @param searchVo 搜索条件
     * @return 公告列表
     */
    @Operation(summary = "搜索公告", description = "根据日期范围搜索公告内容")
    @PostMapping("/search")
    ApiResponse<List<AnnouncementListVo>> searchAnnouncements(@Valid @RequestBody AnnouncementSearchVo searchVo);

    /**
     * 获取公告详情
     *
     * @param id 公告ID
     * @return 公告详情
     */
    @Operation(summary = "获取公告详情", description = "根据公告ID获取公告的详细内容")
    @GetMapping("/{id}")
    ApiResponse<AnnouncementVo> getAnnouncementDetail(@Parameter(description = "公告ID") @PathVariable Long id);

}

package com.lureclub.points.api.user;

import com.lureclub.points.entity.user.vo.request.UserLoginVo;
import com.lureclub.points.entity.user.vo.request.UserRegisterVo;
import com.lureclub.points.entity.user.vo.response.LoginVo;
import com.lureclub.points.entity.user.vo.response.UserVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

/**
 * 用户认证API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "用户认证接口", description = "用户登录、注册相关接口")
@RequestMapping("/api/user/auth")
public interface UserAuthApi {

    /**
     * 用户登录接口
     *
     * @param loginVo 登录信息
     * @return 登录结果包含token
     */
    @Operation(summary = "用户登录", description = "用户使用用户名/手机号和密码登录")
    @PostMapping("/login")
    ApiResponse<LoginVo> login(@Valid @RequestBody UserLoginVo loginVo);

    /**
     * 用户注册接口
     *
     * @param registerVo 注册信息
     * @return 注册结果
     */
    @Operation(summary = "用户注册", description = "新用户注册，需要用户名、密码、手机号")
    @PostMapping("/register")
    ApiResponse<UserVo> register(@Valid @RequestBody UserRegisterVo registerVo);

    /**
     * 获取当前用户信息
     *
     * @return 当前登录用户信息
     */
    @Operation(summary = "获取当前用户信息", description = "根据token获取当前登录用户的详细信息")
    @GetMapping("/current")
    ApiResponse<UserVo> getCurrentUser();

    /**
     * 用户登出接口
     *
     * @return 登出结果
     */
    @Operation(summary = "用户登出", description = "用户登出系统")
    @PostMapping("/logout")
    ApiResponse<String> logout();

}


package com.lureclub.points.api.user;

import com.lureclub.points.entity.message.vo.request.MessageCreateVo;
import com.lureclub.points.entity.message.vo.response.MessageVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 用户留言API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "用户留言接口", description = "用户留言板相关接口")
@RequestMapping("/api/user/message")
public interface UserMessageApi {

    /**
     * 查看所有留言
     *
     * @return 留言列表
     */
    @Operation(summary = "查看所有留言", description = "查看留言板系统所有留言，包含管理员回复")
    @GetMapping("")
    ApiResponse<List<MessageVo>> getAllMessages();

    /**
     * 用户上传留言
     *
     * @param createVo 留言内容
     * @return 创建结果
     */
    @Operation(summary = "上传留言", description = "用户上传新的留言到留言板")
    @PostMapping("")
    ApiResponse<MessageVo> createMessage(@Valid @RequestBody MessageCreateVo createVo);

}


package com.lureclub.points.api.user;

import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 用户积分API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "用户积分接口", description = "用户查看积分相关接口")
@RequestMapping("/api/user/points")
public interface UserPointsApi {

    /**
     * 获取用户积分信息
     *
     * @return 用户积分信息（包含当日积分字段）
     */
    @Operation(summary = "获取用户积分", description = "获取当前用户的积分信息，包含有效积分和总积分")
    @GetMapping("")
    ApiResponse<PointsVo> getUserPoints();

    /**
     * 获取用户积分历史记录
     *
     * @param userId 用户ID（可选，不传则查询当前用户）
     * @return 积分历史记录列表
     */
    @Operation(summary = "获取积分历史", description = "获取用户的详细积分历史记录")
    @GetMapping("/history")
    ApiResponse<List<PointsHistoryVo>> getUserPointsHistory(
            @Parameter(description = "用户ID（可选）") @RequestParam(required = false) Long userId);

    /**
     * 检查是否可抵扣指定积分
     *
     * @param userId 用户ID
     * @param points 要抵扣的积分数量
     * @return 是否可抵扣
     */
    @Operation(summary = "检查积分抵扣", description = "检查用户是否有足够的有效积分进行抵扣")
    @GetMapping("/check-deduct")
    ApiResponse<Boolean> checkDeductPoints(
            @Parameter(description = "用户ID") @RequestParam Long userId,
            @Parameter(description = "抵扣积分数量") @RequestParam Integer points);

}

package com.lureclub.points.api.user;

import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.prize.vo.response.PrizeListVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 用户奖品API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "用户奖品接口", description = "用户查看奖品相关接口")
@RequestMapping("/api/user/prize")
public interface UserPrizeApi {

    /**
     * 获取所有奖品信息
     *
     * @return 奖品列表
     */
    @Operation(summary = "获取所有奖品", description = "获取所有奖品信息，包含图片和描述")
    @GetMapping("")
    ApiResponse<List<PrizeListVo>> getAllPrizes();

    /**
     * 获取奖品详情
     *
     * @param id 奖品ID
     * @return 奖品详情
     */
    @Operation(summary = "获取奖品详情", description = "根据奖品ID获取奖品的详细信息")
    @GetMapping("/{id}")
    ApiResponse<PrizeVo> getPrizeDetail(@Parameter(description = "奖品ID") @PathVariable Long id);

}


package com.lureclub.points.api.user;

import com.lureclub.points.entity.ranking.vo.response.RankingVo;
import com.lureclub.points.entity.ranking.vo.response.RankingItemVo;
import com.lureclub.points.entity.common.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 用户排行榜API接口
 *
 * @author system
 * @date 2025-06-19
 */
@Tag(name = "用户排行榜接口", description = "用户查看排行榜相关接口")
@RequestMapping("/api/user/ranking")
public interface UserRankingApi {

    /**
     * 获取当日排行榜
     *
     * @return 当日排行榜
     */
    @Operation(summary = "获取当日排行榜", description = "根据当日积分获取排行榜")
    @GetMapping("/daily")
    ApiResponse<List<RankingItemVo>> getDailyRanking();

    /**
     * 获取本周排行榜
     *
     * @return 本周排行榜
     */
    @Operation(summary = "获取本周排行榜", description = "根据本周积分获取排行榜")
    @GetMapping("/weekly")
    ApiResponse<List<RankingItemVo>> getWeeklyRanking();

    /**
     * 获取总排行榜
     *
     * @return 总排行榜
     */
    @Operation(summary = "获取总排行榜", description = "根据总积分获取排行榜")
    @GetMapping("/total")
    ApiResponse<List<RankingItemVo>> getTotalRanking();

}

package com.lureclub.points.config;

import org.springframework.boot.web.servlet.MultipartConfigFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.util.unit.DataSize;
import org.springframework.web.multipart.MultipartResolver;
import org.springframework.web.multipart.support.StandardServletMultipartResolver;

import jakarta.servlet.MultipartConfigElement;

/**
 * 文件上传配置类
 *
 * @author system
 * @date 2025-06-19
 */
@Configuration
public class FileUploadConfig {

    /**
     * 配置文件上传解析器
     */
    @Bean
    public MultipartResolver multipartResolver() {
        return new StandardServletMultipartResolver();
    }

    /**
     * 配置文件上传参数
     */
    @Bean
    public MultipartConfigElement multipartConfigElement() {
        MultipartConfigFactory factory = new MultipartConfigFactory();

        // 设置单个文件最大大小
        factory.setMaxFileSize(DataSize.ofMegabytes(10));

        // 设置总上传数据最大大小
        factory.setMaxRequestSize(DataSize.ofMegabytes(10));

        // 设置内存临界值
        factory.setFileSizeThreshold(DataSize.ofKilobytes(1024));

        return factory.createMultipartConfig();
    }

}

package com.lureclub.points.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.domain.AuditorAware;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

import java.util.Optional;

/**
 * JPA配置类
 *
 * @author system
 * @date 2025-06-19
 */
@Configuration
@EnableJpaRepositories(basePackages = "com.lureclub.points.repository")
@EnableJpaAuditing(auditorAwareRef = "auditorProvider")
public class JpaConfig {

    /**
     * 配置审计功能的当前用户提供者
     */
    @Bean
    public AuditorAware<String> auditorProvider() {
        return new AuditorAware<String>() {
            @Override
            public Optional<String> getCurrentAuditor() {
                // 这里可以从Security上下文中获取当前用户
                // 目前返回系统作为审计者
                return Optional.of("system");
            }
        };
    }

}

package com.lureclub.points.config;

import com.lureclub.points.util.JwtUtil;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

/**
 * JWT认证过滤器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        String token = getTokenFromRequest(request);

        if (StringUtils.hasText(token) && jwtUtil.validateToken(token)) {
            Long userId = jwtUtil.getUserIdFromToken(token);

            // 判断是管理员还是普通用户（管理员ID为负数）
            if (userId < 0) {
                // 管理员
                UsernamePasswordAuthenticationToken authentication =
                        new UsernamePasswordAuthenticationToken(
                                userId, // 保持负数，便于区分
                                null,
                                Collections.singletonList(new SimpleGrantedAuthority("ROLE_ADMIN"))
                        );
                SecurityContextHolder.getContext().setAuthentication(authentication);
            } else {
                // 普通用户
                UsernamePasswordAuthenticationToken authentication =
                        new UsernamePasswordAuthenticationToken(
                                userId,
                                null,
                                Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"))
                        );
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        }

        filterChain.doFilter(request, response);
    }

    /**
     * 从请求头中获取Token
     */
    private String getTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }

}

package com.lureclub.points.config;

import com.lureclub.points.config.JwtAuthenticationFilter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

/**
 * Spring Security配置类
 *
 * @author system
 * @date 2025-06-19
 */
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    /**
     * 配置Security过滤链
     */
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authz -> authz
                        // 允许访问的路径
                        .requestMatchers("/api/user/auth/login", "/api/user/auth/register").permitAll()
                        .requestMatchers("/api/admin/auth/login", "/api/admin/auth/create").permitAll()
                        .requestMatchers("/swagger-ui/**", "/v3/api-docs/**", "/swagger-ui.html").permitAll()
                        .requestMatchers("/uploads/**", "/static/**").permitAll()
                        .requestMatchers("/error").permitAll()
                        // 管理员接口需要管理员权限
                        .requestMatchers("/api/admin/**").hasRole("ADMIN")
                        // 用户接口需要用户权限
                        .requestMatchers("/api/user/**").hasRole("USER")
                        // 其他接口需要登录
                        .anyRequest().authenticated()
                )
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    /**
     * CORS配置
     */
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOriginPatterns(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);
        configuration.setMaxAge(3600L);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

}

package com.lureclub.points.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import io.swagger.v3.oas.models.Components;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * Swagger配置类
 *
 * @author system
 * @date 2025-06-19
 */
@Configuration
public class SwaggerConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("雷霆路亚俱乐部积分管理系统API")
                        .description("雷霆路亚俱乐部积分管理系统的API文档")
                        .version("1.0.0")
                        .contact(new Contact()
                                .name("系统开发者")
                                .email("admin@lureclub.com")))
                .addSecurityItem(new SecurityRequirement().addList("bearerAuth"))
                .components(new Components()
                        .addSecuritySchemes("bearerAuth",
                                new SecurityScheme()
                                        .type(SecurityScheme.Type.HTTP)
                                        .scheme("bearer")
                                        .bearerFormat("JWT")
                                        .description("请输入JWT Token")));
    }

}


package com.lureclub.points.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * Web配置类
 *
 * @author system
 * @date 2025-06-19
 */
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Value("${file.upload.path}")
    private String uploadPath;

    /**
     * 配置静态资源处理
     */
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // 配置文件上传路径的静态资源映射
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations("file:" + uploadPath);

        // 配置默认静态资源
        registry.addResourceHandler("/static/**")
                .addResourceLocations("classpath:/static/");
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminAnnouncementApi;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementCreateVo;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementUpdateVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.AnnouncementService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员公告控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminAnnouncementController implements AdminAnnouncementApi {

    @Autowired
    private AnnouncementService announcementService;

    /**
     * 获取所有公告实现（管理员）
     */
    @Override
    public ApiResponse<List<AnnouncementVo>> getAllAnnouncements() {
        try {
            List<AnnouncementVo> result = announcementService.getAllAnnouncementsForAdmin();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取公告列表失败: " + e.getMessage());
        }
    }

    /**
     * 创建公告实现
     */
    @Override
    public ApiResponse<AnnouncementVo> createAnnouncement(@Valid AnnouncementCreateVo createVo) {
        try {
            AnnouncementVo result = announcementService.createAnnouncement(createVo);
            return ApiResponse.success(result, "公告创建成功");
        } catch (Exception e) {
            return ApiResponse.error("创建公告失败: " + e.getMessage());
        }
    }

    /**
     * 更新公告实现
     */
    @Override
    public ApiResponse<AnnouncementVo> updateAnnouncement(Long id, @Valid AnnouncementUpdateVo updateVo) {
        try {
            AnnouncementVo result = announcementService.updateAnnouncement(id, updateVo);
            return ApiResponse.success(result, "公告更新成功");
        } catch (Exception e) {
            return ApiResponse.error("更新公告失败: " + e.getMessage());
        }
    }

    /**
     * 删除公告实现
     */
    @Override
    public ApiResponse<String> deleteAnnouncement(Long id) {
        try {
            announcementService.deleteAnnouncement(id);
            return ApiResponse.success("公告删除成功");
        } catch (Exception e) {
            return ApiResponse.error("删除公告失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminAuthApi;
import com.lureclub.points.entity.admin.vo.request.AdminLoginVo;
import com.lureclub.points.entity.admin.vo.request.AdminCreateVo;
import com.lureclub.points.entity.admin.vo.response.AdminVo;
import com.lureclub.points.entity.admin.vo.response.LoginVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.AdminService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;

/**
 * 管理员认证控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminAuthController implements AdminAuthApi {

    @Autowired
    private AdminService adminService;

    /**
     * 管理员登录实现
     */
    @Override
    public ApiResponse<LoginVo> login(@Valid AdminLoginVo loginVo) {
        try {
            LoginVo result = adminService.login(loginVo);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("登录失败: " + e.getMessage());
        }
    }

    /**
     * 获取当前管理员信息实现
     */
    @Override
    public ApiResponse<AdminVo> getCurrentAdmin() {
        try {
            AdminVo result = adminService.getCurrentAdmin();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取管理员信息失败: " + e.getMessage());
        }
    }

    /**
     * 添加管理员实现
     */
    @Override
    public ApiResponse<AdminVo> createAdmin(@Valid AdminCreateVo createVo) {
        try {
            AdminVo result = adminService.createAdmin(createVo);
            return ApiResponse.success(result, "管理员创建成功");
        } catch (Exception e) {
            return ApiResponse.error("创建管理员失败: " + e.getMessage());
        }
    }

    /**
     * 管理员登出实现
     */
    @Override
    public ApiResponse<String> logout() {
        try {
            adminService.logout();
            return ApiResponse.success("登出成功");
        } catch (Exception e) {
            return ApiResponse.error("登出失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminMessageApi;
import com.lureclub.points.entity.message.vo.request.MessageReplyVo;
import com.lureclub.points.entity.message.vo.response.MessageVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.MessageService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员留言控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminMessageController implements AdminMessageApi {

    @Autowired
    private MessageService messageService;

    /**
     * 获取所有留言实现（管理员）
     */
    @Override
    public ApiResponse<List<MessageVo>> getAllMessages() {
        try {
            List<MessageVo> result = messageService.getAllMessagesForAdmin();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取留言列表失败: " + e.getMessage());
        }
    }

    /**
     * 回复留言实现
     */
    @Override
    public ApiResponse<MessageVo> replyMessage(Long messageId, @Valid MessageReplyVo replyVo) {
        try {
            MessageVo result = messageService.replyMessage(messageId, replyVo);
            return ApiResponse.success(result, "回复成功");
        } catch (Exception e) {
            return ApiResponse.error("回复留言失败: " + e.getMessage());
        }
    }

    /**
     * 设置留言可见性实现
     */
    @Override
    public ApiResponse<MessageVo> setMessageVisibility(Long messageId, Boolean isVisible) {
        try {
            MessageVo result = messageService.setMessageVisibility(messageId, isVisible);
            return ApiResponse.success(result, "设置成功");
        } catch (Exception e) {
            return ApiResponse.error("设置留言可见性失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminPointsApi;
import com.lureclub.points.entity.points.vo.request.PointsAddVo;
import com.lureclub.points.entity.points.vo.request.PointsDeductVo;
import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.PointsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员积分控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminPointsController implements AdminPointsApi {

    @Autowired
    private PointsService pointsService;

    /**
     * 获取所有用户积分数据实现
     */
    @Override
    public ApiResponse<List<PointsVo>> getAllUserPoints() {
        try {
            // 这里需要在PointsService中添加getAllUserPoints方法
            List<PointsVo> result = pointsService.getAllUserPoints();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取用户积分失败: " + e.getMessage());
        }
    }

    /**
     * 搜索单个用户积分数据实现
     */
    @Override
    public ApiResponse<PointsVo> getUserPointsById(Long userId) {
        try {
            PointsVo result = pointsService.getUserPoints(userId);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取用户积分失败: " + e.getMessage());
        }
    }

    /**
     * 获取用户积分历史实现
     */
    @Override
    public ApiResponse<List<PointsHistoryVo>> getUserPointsHistory(Long userId) {
        try {
            List<PointsHistoryVo> result = pointsService.getUserPointsHistory(userId);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取积分历史失败: " + e.getMessage());
        }
    }

    /**
     * 录入用户积分实现
     */
    @Override
    public ApiResponse<PointsVo> addUserPoints(@Valid PointsAddVo pointsAddVo) {
        try {
            PointsVo result = pointsService.addUserPoints(pointsAddVo);
            return ApiResponse.success(result, "积分录入成功");
        } catch (Exception e) {
            return ApiResponse.error("积分录入失败: " + e.getMessage());
        }
    }

    /**
     * 抵扣用户积分实现
     */
    @Override
    public ApiResponse<PointsVo> deductUserPoints(@Valid PointsDeductVo pointsDeductVo) {
        try {
            PointsVo result = pointsService.deductUserPoints(pointsDeductVo);
            return ApiResponse.success(result, "积分抵扣成功");
        } catch (Exception e) {
            return ApiResponse.error("积分抵扣失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminPrizeApi;
import com.lureclub.points.entity.prize.vo.request.PrizeCreateVo;
import com.lureclub.points.entity.prize.vo.request.PrizeUpdateVo;
import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.PrizeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员奖品控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminPrizeController implements AdminPrizeApi {

    @Autowired
    private PrizeService prizeService;

    /**
     * 获取所有奖品实现（管理员）
     */
    @Override
    public ApiResponse<List<PrizeVo>> getAllPrizes() {
        try {
            List<PrizeVo> result = prizeService.getAllPrizesForAdmin();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取奖品列表失败: " + e.getMessage());
        }
    }

    /**
     * 创建奖品实现
     */
    @Override
    public ApiResponse<PrizeVo> createPrize(@Valid PrizeCreateVo createVo, MultipartFile imageFile) {
        try {
            PrizeVo result = prizeService.createPrize(createVo, imageFile);
            return ApiResponse.success(result, "奖品创建成功");
        } catch (Exception e) {
            return ApiResponse.error("创建奖品失败: " + e.getMessage());
        }
    }

    /**
     * 更新奖品实现
     */
    @Override
    public ApiResponse<PrizeVo> updatePrize(Long id, @Valid PrizeUpdateVo updateVo, MultipartFile imageFile) {
        try {
            PrizeVo result = prizeService.updatePrize(id, updateVo, imageFile);
            return ApiResponse.success(result, "奖品更新成功");
        } catch (Exception e) {
            return ApiResponse.error("更新奖品失败: " + e.getMessage());
        }
    }

    /**
     * 删除奖品实现
     */
    @Override
    public ApiResponse<String> deletePrize(Long id) {
        try {
            prizeService.deletePrize(id);
            return ApiResponse.success("奖品删除成功");
        } catch (Exception e) {
            return ApiResponse.error("删除奖品失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminRankingApi;
import com.lureclub.points.entity.ranking.vo.response.RankingItemVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.RankingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * 管理员排行榜控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminRankingController implements AdminRankingApi {

    @Autowired
    private RankingService rankingService;

    /**
     * 获取当日排行榜实现
     */
    @Override
    public ApiResponse<List<RankingItemVo>> getDailyRanking() {
        try {
            List<RankingItemVo> result = rankingService.getDailyRanking();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取当日排行榜失败: " + e.getMessage());
        }
    }

    /**
     * 获取本周排行榜实现
     */
    @Override
    public ApiResponse<List<RankingItemVo>> getWeeklyRanking() {
        try {
            List<RankingItemVo> result = rankingService.getWeeklyRanking();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取本周排行榜失败: " + e.getMessage());
        }
    }

    /**
     * 获取总排行榜实现
     */
    @Override
    public ApiResponse<List<RankingItemVo>> getTotalRanking() {
        try {
            List<RankingItemVo> result = rankingService.getTotalRanking();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取总排行榜失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.admin;

import com.lureclub.points.api.admin.AdminUserApi;
import com.lureclub.points.entity.user.vo.request.UserCreateVo;
import com.lureclub.points.entity.user.vo.request.UserUpdateVo;
import com.lureclub.points.entity.user.vo.request.UserSearchVo;
import com.lureclub.points.entity.user.vo.response.UserVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.AdminUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 管理员用户管理控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class AdminUserController implements AdminUserApi {

    @Autowired
    private AdminUserService adminUserService;

    /**
     * 获取所有用户实现
     */
    @Override
    public ApiResponse<List<UserVo>> getAllUsers() {
        try {
            List<UserVo> result = adminUserService.getAllUsers();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取用户列表失败: " + e.getMessage());
        }
    }

    /**
     * 搜索用户实现
     */
    @Override
    public ApiResponse<List<UserVo>> searchUsers(@Valid UserSearchVo searchVo) {
        try {
            List<UserVo> result = adminUserService.searchUsers(searchVo);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("搜索用户失败: " + e.getMessage());
        }
    }

    /**
     * 创建用户实现
     */
    @Override
    public ApiResponse<UserVo> createUser(@Valid UserCreateVo createVo) {
        try {
            UserVo result = adminUserService.createUser(createVo);
            return ApiResponse.success(result, "用户创建成功");
        } catch (Exception e) {
            return ApiResponse.error("创建用户失败: " + e.getMessage());
        }
    }

    /**
     * 更新用户信息实现
     */
    @Override
    public ApiResponse<UserVo> updateUser(Long userId, @Valid UserUpdateVo updateVo) {
        try {
            UserVo result = adminUserService.updateUser(userId, updateVo);
            return ApiResponse.success(result, "用户更新成功");
        } catch (Exception e) {
            return ApiResponse.error("更新用户失败: " + e.getMessage());
        }
    }

    /**
     * 删除用户实现
     */
    @Override
    public ApiResponse<String> deleteUser(Long userId) {
        try {
            adminUserService.deleteUser(userId);
            return ApiResponse.success("用户删除成功");
        } catch (Exception e) {
            return ApiResponse.error("删除用户失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.user;

import com.lureclub.points.api.user.UserAnnouncementApi;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementSearchVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementListVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.AnnouncementService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 用户公告控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class UserAnnouncementController implements UserAnnouncementApi {

    @Autowired
    private AnnouncementService announcementService;

    /**
     * 获取所有公告内容实现
     */
    @Override
    public ApiResponse<List<AnnouncementListVo>> getAllAnnouncements() {
        try {
            List<AnnouncementListVo> result = announcementService.getAllAnnouncements();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取公告列表失败: " + e.getMessage());
        }
    }

    /**
     * 根据日期搜索公告实现
     */
    @Override
    public ApiResponse<List<AnnouncementListVo>> searchAnnouncements(@Valid AnnouncementSearchVo searchVo) {
        try {
            List<AnnouncementListVo> result = announcementService.searchAnnouncements(searchVo);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("搜索公告失败: " + e.getMessage());
        }
    }

    /**
     * 获取公告详情实现
     */
    @Override
    public ApiResponse<AnnouncementVo> getAnnouncementDetail(Long id) {
        try {
            AnnouncementVo result = announcementService.getAnnouncementDetail(id);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取公告详情失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.user;

import com.lureclub.points.api.user.UserAuthApi;
import com.lureclub.points.entity.user.vo.request.UserLoginVo;
import com.lureclub.points.entity.user.vo.request.UserRegisterVo;
import com.lureclub.points.entity.user.vo.response.LoginVo;
import com.lureclub.points.entity.user.vo.response.UserVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;

/**
 * 用户认证控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class UserAuthController implements UserAuthApi {

    @Autowired
    private UserService userService;

    /**
     * 用户登录接口实现
     */
    @Override
    public ApiResponse<LoginVo> login(@Valid UserLoginVo loginVo) {
        try {
            LoginVo result = userService.login(loginVo);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("登录失败: " + e.getMessage());
        }
    }

    /**
     * 用户注册接口实现
     */
    @Override
    public ApiResponse<UserVo> register(@Valid UserRegisterVo registerVo) {
        try {
            UserVo result = userService.register(registerVo);
            return ApiResponse.success(result, "注册成功");
        } catch (Exception e) {
            return ApiResponse.error("注册失败: " + e.getMessage());
        }
    }

    /**
     * 获取当前用户信息实现
     */
    @Override
    public ApiResponse<UserVo> getCurrentUser() {
        try {
            UserVo result = userService.getCurrentUser();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取用户信息失败: " + e.getMessage());
        }
    }

    /**
     * 用户登出接口实现
     */
    @Override
    public ApiResponse<String> logout() {
        try {
            userService.logout();
            return ApiResponse.success("登出成功");
        } catch (Exception e) {
            return ApiResponse.error("登出失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.user;

import com.lureclub.points.api.user.UserMessageApi;
import com.lureclub.points.entity.message.vo.request.MessageCreateVo;
import com.lureclub.points.entity.message.vo.response.MessageVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.MessageService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import jakarta.validation.Valid;
import java.util.List;

/**
 * 用户留言控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class UserMessageController implements UserMessageApi {

    @Autowired
    private MessageService messageService;

    /**
     * 查看所有留言实现
     */
    @Override
    public ApiResponse<List<MessageVo>> getAllMessages() {
        try {
            List<MessageVo> result = messageService.getAllPublicMessages();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取留言列表失败: " + e.getMessage());
        }
    }

    /**
     * 用户上传留言实现
     */
    @Override
    public ApiResponse<MessageVo> createMessage(@Valid MessageCreateVo createVo) {
        try {
            MessageVo result = messageService.createMessage(createVo);
            return ApiResponse.success(result, "留言发布成功，等待审核");
        } catch (Exception e) {
            return ApiResponse.error("发布留言失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.user;

import com.lureclub.points.api.user.UserPointsApi;
import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.PointsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * 用户积分控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class UserPointsController implements UserPointsApi {

    @Autowired
    private PointsService pointsService;

    /**
     * 获取用户积分信息实现
     */
    @Override
    public ApiResponse<PointsVo> getUserPoints() {
        try {
            PointsVo result = pointsService.getUserPoints(null);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取积分信息失败: " + e.getMessage());
        }
    }

    /**
     * 获取用户积分历史记录实现
     */
    @Override
    public ApiResponse<List<PointsHistoryVo>> getUserPointsHistory(Long userId) {
        try {
            List<PointsHistoryVo> result = pointsService.getUserPointsHistory(userId);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取积分历史失败: " + e.getMessage());
        }
    }

    /**
     * 检查是否可抵扣指定积分实现
     */
    @Override
    public ApiResponse<Boolean> checkDeductPoints(Long userId, Integer points) {
        try {
            Boolean result = pointsService.checkDeductPoints(userId, points);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("检查抵扣失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.user;

import com.lureclub.points.api.user.UserPrizeApi;
import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.prize.vo.response.PrizeListVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.PrizeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * 用户奖品控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class UserPrizeController implements UserPrizeApi {

    @Autowired
    private PrizeService prizeService;

    /**
     * 获取所有奖品信息实现
     */
    @Override
    public ApiResponse<List<PrizeListVo>> getAllPrizes() {
        try {
            List<PrizeListVo> result = prizeService.getAllPrizes();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取奖品列表失败: " + e.getMessage());
        }
    }

    /**
     * 获取奖品详情实现
     */
    @Override
    public ApiResponse<PrizeVo> getPrizeDetail(Long id) {
        try {
            PrizeVo result = prizeService.getPrizeDetail(id);
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取奖品详情失败: " + e.getMessage());
        }
    }

}

package com.lureclub.points.controller.user;

import com.lureclub.points.api.user.UserRankingApi;
import com.lureclub.points.entity.ranking.vo.response.RankingItemVo;
import com.lureclub.points.entity.common.ApiResponse;
import com.lureclub.points.service.RankingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * 用户排行榜控制器实现
 *
 * @author system
 * @date 2025-06-19
 */
@RestController
public class UserRankingController implements UserRankingApi {

    @Autowired
    private RankingService rankingService;

    /**
     * 获取当日排行榜实现
     */
    @Override
    public ApiResponse<List<RankingItemVo>> getDailyRanking() {
        try {
            List<RankingItemVo> result = rankingService.getDailyRanking();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取当日排行榜失败: " + e.getMessage());
        }
    }

    /**
     * 获取本周排行榜实现
     */
    @Override
    public ApiResponse<List<RankingItemVo>> getWeeklyRanking() {
        try {
            List<RankingItemVo> result = rankingService.getWeeklyRanking();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取本周排行榜失败: " + e.getMessage());
        }
    }

    /**
     * 获取总排行榜实现
     */
    @Override
    public ApiResponse<List<RankingItemVo>> getTotalRanking() {
        try {
            List<RankingItemVo> result = rankingService.getTotalRanking();
            return ApiResponse.success(result);
        } catch (Exception e) {
            return ApiResponse.error("获取总排行榜失败: " + e.getMessage());
        }
    }

}


package com.lureclub.points.entity.admin.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

/**
 * 管理员创建请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "管理员创建请求参数")
public class AdminCreateVo {

    @Schema(description = "管理员用户名", example = "admin")
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 20, message = "用户名长度必须在3-20个字符之间")
    private String username;

    @Schema(description = "密码", example = "admin123")
    @NotBlank(message = "密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度必须在6-20个字符之间")
    private String password;

    @Schema(description = "真实姓名", example = "张三")
    private String realName;

    // 构造函数
    public AdminCreateVo() {}

    public AdminCreateVo(String username, String password, String realName) {
        this.username = username;
        this.password = password;
        this.realName = realName;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getRealName() {
        return realName;
    }

    public void setRealName(String realName) {
        this.realName = realName;
    }

}


package com.lureclub.points.entity.admin.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;

/**
 * 管理员登录请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "管理员登录请求参数")
public class AdminLoginVo {

    @Schema(description = "管理员用户名", example = "admin")
    @NotBlank(message = "用户名不能为空")
    private String username;

    @Schema(description = "密码", example = "admin123")
    @NotBlank(message = "密码不能为空")
    private String password;

    // 构造函数
    public AdminLoginVo() {}

    public AdminLoginVo(String username, String password) {
        this.username = username;
        this.password = password;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

}

package com.lureclub.points.entity.admin.vo.request;

public class AdminUpdateVo {
}

package com.lureclub.points.entity.admin.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;

/**
 * 管理员列表响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "管理员列表信息")
public class AdminListVo {

    @Schema(description = "管理员ID")
    private Long id;

    @Schema(description = "管理员用户名")
    private String username;

    @Schema(description = "真实姓名")
    private String realName;

    @Schema(description = "是否启用")
    private Boolean isEnabled;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    @Schema(description = "最后登录时间")
    private LocalDateTime lastLoginTime;

    // 构造函数
    public AdminListVo() {}

    public AdminListVo(Long id, String username, String realName, Boolean isEnabled,
                       LocalDateTime createTime, LocalDateTime lastLoginTime) {
        this.id = id;
        this.username = username;
        this.realName = realName;
        this.isEnabled = isEnabled;
        this.createTime = createTime;
        this.lastLoginTime = lastLoginTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getRealName() {
        return realName;
    }

    public void setRealName(String realName) {
        this.realName = realName;
    }

    public Boolean getIsEnabled() {
        return isEnabled;
    }

    public void setIsEnabled(Boolean isEnabled) {
        this.isEnabled = isEnabled;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getLastLoginTime() {
        return lastLoginTime;
    }

    public void setLastLoginTime(LocalDateTime lastLoginTime) {
        this.lastLoginTime = lastLoginTime;
    }

}

package com.lureclub.points.entity.admin.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;

/**
 * 管理员信息响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "管理员信息")
public class AdminVo {

    @Schema(description = "管理员ID")
    private Long id;

    @Schema(description = "管理员用户名")
    private String username;

    @Schema(description = "真实姓名")
    private String realName;

    @Schema(description = "是否启用")
    private Boolean isEnabled;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public AdminVo() {}

    public AdminVo(Long id, String username, String realName, Boolean isEnabled, LocalDateTime createTime) {
        this.id = id;
        this.username = username;
        this.realName = realName;
        this.isEnabled = isEnabled;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getRealName() {
        return realName;
    }

    public void setRealName(String realName) {
        this.realName = realName;
    }

    public Boolean getIsEnabled() {
        return isEnabled;
    }

    public void setIsEnabled(Boolean isEnabled) {
        this.isEnabled = isEnabled;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.admin.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 管理员登录响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "管理员登录响应信息")
public class LoginVo {

    @Schema(description = "访问令牌")
    private String token;

    @Schema(description = "令牌类型", example = "Bearer")
    private String tokenType = "Bearer";

    @Schema(description = "管理员信息")
    private AdminVo adminInfo;

    // 构造函数
    public LoginVo() {}

    public LoginVo(String token, AdminVo adminInfo) {
        this.token = token;
        this.adminInfo = adminInfo;
    }

    public LoginVo(String token, String tokenType, AdminVo adminInfo) {
        this.token = token;
        this.tokenType = tokenType;
        this.adminInfo = adminInfo;
    }

    // Getter和Setter方法
    public String getToken() {
        return token;
    }

    public void setToken(String token) {
        this.token = token;
    }

    public String getTokenType() {
        return tokenType;
    }

    public void setTokenType(String tokenType) {
        this.tokenType = tokenType;
    }

    public AdminVo getAdminInfo() {
        return adminInfo;
    }

    public void setAdminInfo(AdminVo adminInfo) {
        this.adminInfo = adminInfo;
    }

}

package com.lureclub.points.entity.admin;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import java.time.LocalDateTime;

/**
 * 管理员实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "admins")
public class Admin {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 管理员用户名
     */
    @Column(unique = true, nullable = false, length = 50)
    @NotBlank(message = "用户名不能为空")
    private String username;

    /**
     * 密码
     */
    @Column(nullable = false, length = 255)
    @NotBlank(message = "密码不能为空")
    private String password;

    /**
     * 真实姓名
     */
    @Column(name = "real_name", length = 50)
    private String realName;

    /**
     * 是否启用
     */
    @Column(name = "is_enabled", nullable = false)
    private Boolean isEnabled = true;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * 是否删除 (0:未删除 1:已删除)
     */
    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0;

    // 构造函数
    public Admin() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
    }

    public Admin(String username, String password) {
        this();
        this.username = username;
        this.password = password;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getRealName() {
        return realName;
    }

    public void setRealName(String realName) {
        this.realName = realName;
    }

    public Boolean getIsEnabled() {
        return isEnabled;
    }

    public void setIsEnabled(Boolean isEnabled) {
        this.isEnabled = isEnabled;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    public Integer getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(Integer isDeleted) {
        this.isDeleted = isDeleted;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}


package com.lureclub.points.entity.admin;

import com.lureclub.points.entity.admin.vo.response.AdminVo;
import org.springframework.stereotype.Component;

/**
 * 管理员转换器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class AdminConverter {

    /**
     * 将Admin实体转换为AdminVo
     *
     * @param admin 管理员实体
     * @return 管理员VO
     */
    public AdminVo toAdminVo(Admin admin) {
        if (admin == null) {
            return null;
        }
        return new AdminVo(
                admin.getId(),
                admin.getUsername(),
                admin.getRealName(),
                admin.getIsEnabled(),
                admin.getCreateTime()
        );
    }

}

package com.lureclub.points.entity.announcement.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import org.springframework.format.annotation.DateTimeFormat;

import java.time.LocalDate;

/**
 * 公告创建请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "公告创建请求参数")
public class AnnouncementCreateVo {

    @Schema(description = "公告标题", example = "钓场开放通知")
    @NotBlank(message = "公告标题不能为空")
    private String title;

    @Schema(description = "公告内容", example = "本钓场将于明日正式开放...")
    @NotBlank(message = "公告内容不能为空")
    private String content;

    @Schema(description = "发布日期", example = "2025-06-20")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate publishDate;

    @Schema(description = "是否置顶", example = "false")
    private Boolean isTop = false;

    // 构造函数
    public AnnouncementCreateVo() {}

    public AnnouncementCreateVo(String title, String content, LocalDate publishDate, Boolean isTop) {
        this.title = title;
        this.content = content;
        this.publishDate = publishDate;
        this.isTop = isTop;
    }

    // Getter和Setter方法
    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public LocalDate getPublishDate() {
        return publishDate;
    }

    public void setPublishDate(LocalDate publishDate) {
        this.publishDate = publishDate;
    }

    public Boolean getIsTop() {
        return isTop;
    }

    public void setIsTop(Boolean isTop) {
        this.isTop = isTop;
    }

}

package com.lureclub.points.entity.announcement.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import org.springframework.format.annotation.DateTimeFormat;

import java.time.LocalDate;

/**
 * 公告搜索请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "公告搜索请求参数")
public class AnnouncementSearchVo {

    @Schema(description = "开始日期", example = "2025-06-01")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate startDate;

    @Schema(description = "结束日期", example = "2025-06-30")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate endDate;

    @Schema(description = "关键词搜索（标题或内容）", example = "钓鱼")
    private String keyword;

    @Schema(description = "是否只显示置顶公告")
    private Boolean onlyTop;

    // 构造函数
    public AnnouncementSearchVo() {}

    public AnnouncementSearchVo(LocalDate startDate, LocalDate endDate, String keyword, Boolean onlyTop) {
        this.startDate = startDate;
        this.endDate = endDate;
        this.keyword = keyword;
        this.onlyTop = onlyTop;
    }

    // Getter和Setter方法
    public LocalDate getStartDate() {
        return startDate;
    }

    public void setStartDate(LocalDate startDate) {
        this.startDate = startDate;
    }

    public LocalDate getEndDate() {
        return endDate;
    }

    public void setEndDate(LocalDate endDate) {
        this.endDate = endDate;
    }

    public String getKeyword() {
        return keyword;
    }

    public void setKeyword(String keyword) {
        this.keyword = keyword;
    }

    public Boolean getOnlyTop() {
        return onlyTop;
    }

    public void setOnlyTop(Boolean onlyTop) {
        this.onlyTop = onlyTop;
    }

}

package com.lureclub.points.entity.announcement.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import org.springframework.format.annotation.DateTimeFormat;

import java.time.LocalDate;

/**
 * 公告更新请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "公告更新请求参数")
public class AnnouncementUpdateVo {

    @Schema(description = "公告标题", example = "钓场开放通知")
    private String title;

    @Schema(description = "公告内容", example = "本钓场将于明日正式开放...")
    private String content;

    @Schema(description = "发布日期", example = "2025-06-20")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate publishDate;

    @Schema(description = "是否置顶", example = "false")
    private Boolean isTop;

    // 构造函数
    public AnnouncementUpdateVo() {}

    public AnnouncementUpdateVo(String title, String content, LocalDate publishDate, Boolean isTop) {
        this.title = title;
        this.content = content;
        this.publishDate = publishDate;
        this.isTop = isTop;
    }

    // Getter和Setter方法
    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public LocalDate getPublishDate() {
        return publishDate;
    }

    public void setPublishDate(LocalDate publishDate) {
        this.publishDate = publishDate;
    }

    public Boolean getIsTop() {
        return isTop;
    }

    public void setIsTop(Boolean isTop) {
        this.isTop = isTop;
    }

}

package com.lureclub.points.entity.announcement.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;

/**
 * 公告列表响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "公告列表信息")
public class AnnouncementListVo {

    @Schema(description = "公告ID")
    private Long id;

    @Schema(description = "公告标题")
    private String title;

    @Schema(description = "公告内容摘要（前100个字符）")
    private String summary;

    @Schema(description = "发布日期")
    private LocalDate publishDate;

    @Schema(description = "是否置顶")
    private Boolean isTop;

    // 构造函数
    public AnnouncementListVo() {}

    public AnnouncementListVo(Long id, String title, String content, LocalDate publishDate, Boolean isTop) {
        this.id = id;
        this.title = title;
        this.publishDate = publishDate;
        this.isTop = isTop;
        // 生成摘要，最多100个字符
        if (content != null) {
            this.summary = content.length() > 100 ? content.substring(0, 100) + "..." : content;
        }
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getSummary() {
        return summary;
    }

    public void setSummary(String summary) {
        this.summary = summary;
    }

    public LocalDate getPublishDate() {
        return publishDate;
    }

    public void setPublishDate(LocalDate publishDate) {
        this.publishDate = publishDate;
    }

    public Boolean getIsTop() {
        return isTop;
    }

    public void setIsTop(Boolean isTop) {
        this.isTop = isTop;
    }

}

package com.lureclub.points.entity.announcement.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * 公告详情响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "公告详情信息")
public class AnnouncementVo {

    @Schema(description = "公告ID")
    private Long id;

    @Schema(description = "公告标题")
    private String title;

    @Schema(description = "公告内容")
    private String content;

    @Schema(description = "发布日期")
    private LocalDate publishDate;

    @Schema(description = "是否置顶")
    private Boolean isTop;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public AnnouncementVo() {}

    public AnnouncementVo(Long id, String title, String content, LocalDate publishDate,
                          Boolean isTop, LocalDateTime createTime) {
        this.id = id;
        this.title = title;
        this.content = content;
        this.publishDate = publishDate;
        this.isTop = isTop;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public LocalDate getPublishDate() {
        return publishDate;
    }

    public void setPublishDate(LocalDate publishDate) {
        this.publishDate = publishDate;
    }

    public Boolean getIsTop() {
        return isTop;
    }

    public void setIsTop(Boolean isTop) {
        this.isTop = isTop;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.announcement;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * 公告实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "announcements")
public class Announcement {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 公告标题
     */
    @Column(nullable = false, length = 200)
    @NotBlank(message = "公告标题不能为空")
    private String title;

    /**
     * 公告内容
     */
    @Column(nullable = false, columnDefinition = "TEXT")
    @NotBlank(message = "公告内容不能为空")
    private String content;

    /**
     * 发布日期
     */
    @Column(name = "publish_date", nullable = false)
    private LocalDate publishDate;

    /**
     * 是否置顶
     */
    @Column(name = "is_top", nullable = false)
    private Boolean isTop = false;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * 是否删除 (0:未删除 1:已删除)
     */
    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0;

    // 构造函数
    public Announcement() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
        this.publishDate = LocalDate.now();
    }

    public Announcement(String title, String content) {
        this();
        this.title = title;
        this.content = content;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public LocalDate getPublishDate() {
        return publishDate;
    }

    public void setPublishDate(LocalDate publishDate) {
        this.publishDate = publishDate;
    }

    public Boolean getIsTop() {
        return isTop;
    }

    public void setIsTop(Boolean isTop) {
        this.isTop = isTop;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    public Integer getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(Integer isDeleted) {
        this.isDeleted = isDeleted;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}

package com.lureclub.points.entity.announcement;

import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementListVo;
import org.springframework.stereotype.Component;

/**
 * 公告转换器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class AnnouncementConverter {

    /**
     * 将Announcement实体转换为AnnouncementVo
     *
     * @param announcement 公告实体
     * @return 公告VO
     */
    public AnnouncementVo toAnnouncementVo(Announcement announcement) {
        if (announcement == null) {
            return null;
        }
        return new AnnouncementVo(
                announcement.getId(),
                announcement.getTitle(),
                announcement.getContent(),
                announcement.getPublishDate(),
                announcement.getIsTop(),
                announcement.getCreateTime()
        );
    }

    /**
     * 将Announcement实体转换为AnnouncementListVo
     *
     * @param announcement 公告实体
     * @return 公告列表VO
     */
    public AnnouncementListVo toAnnouncementListVo(Announcement announcement) {
        if (announcement == null) {
            return null;
        }
        return new AnnouncementListVo(
                announcement.getId(),
                announcement.getTitle(),
                announcement.getContent(),
                announcement.getPublishDate(),
                announcement.getIsTop()
        );
    }

}

package com.lureclub.points.entity.common;

import io.swagger.v3.oas.annotations.media.Schema;
import java.util.List;

/**
 * 分页响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "分页信息")
public class PageVo<T> {

    @Schema(description = "数据列表")
    private List<T> content;

    @Schema(description = "当前页码", example = "1")
    private Integer pageNumber;

    @Schema(description = "每页大小", example = "10")
    private Integer pageSize;

    @Schema(description = "总页数", example = "5")
    private Integer totalPages;

    @Schema(description = "总记录数", example = "50")
    private Long totalElements;

    @Schema(description = "是否是第一页")
    private Boolean first;

    @Schema(description = "是否是最后一页")
    private Boolean last;

    @Schema(description = "是否有下一页")
    private Boolean hasNext;

    @Schema(description = "是否有上一页")
    private Boolean hasPrevious;

    // 构造函数
    public PageVo() {}

    public PageVo(List<T> content, Integer pageNumber, Integer pageSize, Integer totalPages,
                  Long totalElements, Boolean first, Boolean last, Boolean hasNext, Boolean hasPrevious) {
        this.content = content;
        this.pageNumber = pageNumber;
        this.pageSize = pageSize;
        this.totalPages = totalPages;
        this.totalElements = totalElements;
        this.first = first;
        this.last = last;
        this.hasNext = hasNext;
        this.hasPrevious = hasPrevious;
    }

    // 静态方法创建分页对象
    public static <T> PageVo<T> of(List<T> content, Integer pageNumber, Integer pageSize, Long totalElements) {
        Integer totalPages = (int) Math.ceil((double) totalElements / pageSize);
        Boolean first = pageNumber == 1;
        Boolean last = pageNumber.equals(totalPages);
        Boolean hasNext = pageNumber < totalPages;
        Boolean hasPrevious = pageNumber > 1;

        return new PageVo<>(content, pageNumber, pageSize, totalPages, totalElements,
                first, last, hasNext, hasPrevious);
    }

    // Getter和Setter方法
    public List<T> getContent() {
        return content;
    }

    public void setContent(List<T> content) {
        this.content = content;
    }

    public Integer getPageNumber() {
        return pageNumber;
    }

    public void setPageNumber(Integer pageNumber) {
        this.pageNumber = pageNumber;
    }

    public Integer getPageSize() {
        return pageSize;
    }

    public void setPageSize(Integer pageSize) {
        this.pageSize = pageSize;
    }

    public Integer getTotalPages() {
        return totalPages;
    }

    public void setTotalPages(Integer totalPages) {
        this.totalPages = totalPages;
    }

    public Long getTotalElements() {
        return totalElements;
    }

    public void setTotalElements(Long totalElements) {
        this.totalElements = totalElements;
    }

    public Boolean getFirst() {
        return first;
    }

    public void setFirst(Boolean first) {
        this.first = first;
    }

    public Boolean getLast() {
        return last;
    }

    public void setLast(Boolean last) {
        this.last = last;
    }

    public Boolean getHasNext() {
        return hasNext;
    }

    public void setHasNext(Boolean hasNext) {
        this.hasNext = hasNext;
    }

    public Boolean getHasPrevious() {
        return hasPrevious;
    }

    public void setHasPrevious(Boolean hasPrevious) {
        this.hasPrevious = hasPrevious;
    }

}

package com.lureclub.points.entity.common;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 统一API响应类
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "统一响应格式")
public class ApiResponse<T> {

    @Schema(description = "响应码")
    private Integer code;

    @Schema(description = "响应消息")
    private String message;

    @Schema(description = "响应数据")
    private T data;

    @Schema(description = "时间戳")
    private Long timestamp;

    // 构造函数
    public ApiResponse() {
        this.timestamp = System.currentTimeMillis();
    }

    public ApiResponse(Integer code, String message, T data) {
        this();
        this.code = code;
        this.message = message;
        this.data = data;
    }

    /**
     * 成功响应
     */
    public static <T> ApiResponse<T> success(T data) {
        return new ApiResponse<>(200, "成功", data);
    }

    /**
     * 成功响应带消息
     */
    public static <T> ApiResponse<T> success(T data, String message) {
        return new ApiResponse<>(200, message, data);
    }

    /**
     * 成功响应无数据
     */
    public static <T> ApiResponse<T> success(String message) {
        return new ApiResponse<>(200, message, null);
    }

    /**
     * 错误响应
     */
    public static <T> ApiResponse<T> error(String message) {
        return new ApiResponse<>(500, message, null);
    }

    /**
     * 错误响应带状态码
     */
    public static <T> ApiResponse<T> error(Integer code, String message) {
        return new ApiResponse<>(code, message, null);
    }

    // Getter和Setter方法
    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public T getData() {
        return data;
    }

    public void setData(T data) {
        this.data = data;
    }

    public Long getTimestamp() {
        return timestamp;
    }

    public void setTimestamp(Long timestamp) {
        this.timestamp = timestamp;
    }

}

package com.lureclub.points.entity.message.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

/**
 * 留言创建请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "留言创建请求参数")
public class MessageCreateVo {

    @Schema(description = "留言内容", example = "今天钓鱼收获不错！")
    @NotBlank(message = "留言内容不能为空")
    @Size(max = 1000, message = "留言内容不能超过1000个字符")
    private String content;

    // 构造函数
    public MessageCreateVo() {}

    public MessageCreateVo(String content) {
        this.content = content;
    }

    // Getter和Setter方法
    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

}


package com.lureclub.points.entity.message.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;

/**
 * 留言回复请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "留言回复请求参数")
public class MessageReplyVo {

    @Schema(description = "回复内容", example = "感谢您的留言！")
    @NotBlank(message = "回复内容不能为空")
    private String content;

    @Schema(description = "是否公开可见", example = "true")
    private Boolean isVisible = true;

    // 构造函数
    public MessageReplyVo() {}

    public MessageReplyVo(String content, Boolean isVisible) {
        this.content = content;
        this.isVisible = isVisible;
    }

    // Getter和Setter方法
    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public Boolean getIsVisible() {
        return isVisible;
    }

    public void setIsVisible(Boolean isVisible) {
        this.isVisible = isVisible;
    }

}

package com.lureclub.points.entity.message.vo.request;

public class MessageSearchVo {
}


package com.lureclub.points.entity.message.vo.request;

public class MessageUpdateVo {
}


package com.lureclub.points.entity.message.vo.response;

public class MessageListVo {
}

package com.lureclub.points.entity.message.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;

/**
 * 留言回复响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "留言回复信息")
public class MessageReplyVo {

    @Schema(description = "回复ID")
    private Long id;

    @Schema(description = "留言ID")
    private Long messageId;

    @Schema(description = "回复内容")
    private String content;

    @Schema(description = "是否公开可见")
    private Boolean isVisible;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public MessageReplyVo() {}

    public MessageReplyVo(Long id, Long messageId, String content, Boolean isVisible, LocalDateTime createTime) {
        this.id = id;
        this.messageId = messageId;
        this.content = content;
        this.isVisible = isVisible;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getMessageId() {
        return messageId;
    }

    public void setMessageId(Long messageId) {
        this.messageId = messageId;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public Boolean getIsVisible() {
        return isVisible;
    }

    public void setIsVisible(Boolean isVisible) {
        this.isVisible = isVisible;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.message.vo.response;

import com.lureclub.points.enums.MessageStatus;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;
import java.util.List;

/**
 * 留言信息响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "留言信息")
public class MessageVo {

    @Schema(description = "留言ID")
    private Long id;

    @Schema(description = "用户ID")
    private Long userId;

    @Schema(description = "用户名")
    private String username;

    @Schema(description = "留言内容")
    private String content;

    @Schema(description = "留言状态")
    private MessageStatus status;

    @Schema(description = "留言状态描述")
    private String statusDesc;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    @Schema(description = "回复列表")
    private List<MessageReplyVo> replies;

    // 构造函数
    public MessageVo() {}

    public MessageVo(Long id, Long userId, String username, String content,
                     MessageStatus status, LocalDateTime createTime, List<MessageReplyVo> replies) {
        this.id = id;
        this.userId = userId;
        this.username = username;
        this.content = content;
        this.status = status;
        this.statusDesc = status != null ? status.getDescription() : null;
        this.createTime = createTime;
        this.replies = replies;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public MessageStatus getStatus() {
        return status;
    }

    public void setStatus(MessageStatus status) {
        this.status = status;
        this.statusDesc = status != null ? status.getDescription() : null;
    }

    public String getStatusDesc() {
        return statusDesc;
    }

    public void setStatusDesc(String statusDesc) {
        this.statusDesc = statusDesc;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public List<MessageReplyVo> getReplies() {
        return replies;
    }

    public void setReplies(List<MessageReplyVo> replies) {
        this.replies = replies;
    }

}

package com.lureclub.points.entity.message;

import com.lureclub.points.enums.MessageStatus;
import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import java.time.LocalDateTime;

/**
 * 留言实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "messages")
public class Message {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 用户ID
     */
    @Column(name = "user_id", nullable = false)
    private Long userId;

    /**
     * 留言内容
     */
    @Column(nullable = false, columnDefinition = "TEXT")
    @NotBlank(message = "留言内容不能为空")
    private String content;

    /**
     * 留言状态
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private MessageStatus status = MessageStatus.PENDING;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * 是否删除 (0:未删除 1:已删除)
     */
    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0;

    // 构造函数
    public Message() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
    }

    public Message(Long userId, String content) {
        this();
        this.userId = userId;
        this.content = content;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public MessageStatus getStatus() {
        return status;
    }

    public void setStatus(MessageStatus status) {
        this.status = status;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    public Integer getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(Integer isDeleted) {
        this.isDeleted = isDeleted;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}

package com.lureclub.points.entity.message;

import com.lureclub.points.entity.message.vo.response.MessageVo;
import com.lureclub.points.entity.message.vo.response.MessageReplyVo;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * 留言转换器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class MessageConverter {

    /**
     * 将Message实体转换为MessageVo
     *
     * @param message 留言实体
     * @param username 用户名
     * @param replies 回复列表
     * @return 留言VO
     */
    public MessageVo toMessageVo(Message message, String username, List<MessageReplyVo> replies) {
        if (message == null) {
            return null;
        }
        return new MessageVo(
                message.getId(),
                message.getUserId(),
                username,
                message.getContent(),
                message.getStatus(),
                message.getCreateTime(),
                replies
        );
    }

    /**
     * 将MessageReply实体转换为MessageReplyVo
     *
     * @param reply 回复实体
     * @return 回复VO
     */
    public MessageReplyVo toMessageReplyVo(MessageReply reply) {
        if (reply == null) {
            return null;
        }
        return new MessageReplyVo(
                reply.getId(),
                reply.getMessageId(),
                reply.getContent(),
                reply.getIsVisible(),
                reply.getCreateTime()
        );
    }

}

package com.lureclub.points.entity.message;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import java.time.LocalDateTime;

/**
 * 留言回复实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "message_replies")
public class MessageReply {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 留言ID
     */
    @Column(name = "message_id", nullable = false)
    private Long messageId;

    /**
     * 回复内容
     */
    @Column(nullable = false, columnDefinition = "TEXT")
    @NotBlank(message = "回复内容不能为空")
    private String content;

    /**
     * 是否公开可见
     */
    @Column(name = "is_visible", nullable = false)
    private Boolean isVisible = true;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * 是否删除 (0:未删除 1:已删除)
     */
    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0;

    // 构造函数
    public MessageReply() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
    }

    public MessageReply(Long messageId, String content, Boolean isVisible) {
        this();
        this.messageId = messageId;
        this.content = content;
        this.isVisible = isVisible;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getMessageId() {
        return messageId;
    }

    public void setMessageId(Long messageId) {
        this.messageId = messageId;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public Boolean getIsVisible() {
        return isVisible;
    }

    public void setIsVisible(Boolean isVisible) {
        this.isVisible = isVisible;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    public Integer getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(Integer isDeleted) {
        this.isDeleted = isDeleted;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}

package com.lureclub.points.entity.points.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;

/**
 * 积分录入请求VO（管理员操作）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "积分录入请求参数")
public class PointsAddVo {

    @Schema(description = "用户ID", example = "1")
    @NotNull(message = "用户ID不能为空")
    private Long userId;

    @Schema(description = "录入积分数量", example = "10")
    @NotNull(message = "积分数量不能为空")
    @Positive(message = "积分数量必须大于0")
    private Integer points;

    @Schema(description = "备注说明", example = "钓鱼获得积分")
    private String remark;

    // 构造函数
    public PointsAddVo() {}

    public PointsAddVo(Long userId, Integer points, String remark) {
        this.userId = userId;
        this.points = points;
        this.remark = remark;
    }

    // Getter和Setter方法
    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    public String getRemark() {
        return remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

}

package com.lureclub.points.entity.points.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;

/**
 * 积分抵扣请求VO（管理员操作）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "积分抵扣请求参数")
public class PointsDeductVo {

    @Schema(description = "用户ID", example = "1")
    @NotNull(message = "用户ID不能为空")
    private Long userId;

    @Schema(description = "抵扣积分数量", example = "8")
    @NotNull(message = "积分数量不能为空")
    @Positive(message = "积分数量必须大于0")
    private Integer points;

    @Schema(description = "备注说明", example = "门票抵扣")
    private String remark;

    // 构造函数
    public PointsDeductVo() {}

    public PointsDeductVo(Long userId, Integer points, String remark) {
        this.userId = userId;
        this.points = points;
        this.remark = remark;
    }

    // Getter和Setter方法
    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    public String getRemark() {
        return remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

}

package com.lureclub.points.entity.points.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import org.springframework.format.annotation.DateTimeFormat;

import java.time.LocalDate;

/**
 * 积分搜索请求VO（积分搜索VO）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "积分搜索请求参数")
public class PointsSearchVo {

    @Schema(description = "用户ID", example = "1")
    private Long userId;

    @Schema(description = "用户名关键词", example = "test")
    private String username;

    @Schema(description = "开始日期", example = "2025-06-01")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate startDate;

    @Schema(description = "结束日期", example = "2025-06-30")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate endDate;

    @Schema(description = "最小积分", example = "10")
    private Integer minPoints;

    @Schema(description = "最大积分", example = "100")
    private Integer maxPoints;

    // 构造函数
    public PointsSearchVo() {}

    public PointsSearchVo(Long userId, String username, LocalDate startDate, LocalDate endDate,
                          Integer minPoints, Integer maxPoints) {
        this.userId = userId;
        this.username = username;
        this.startDate = startDate;
        this.endDate = endDate;
        this.minPoints = minPoints;
        this.maxPoints = maxPoints;
    }

    // Getter和Setter方法
    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public LocalDate getStartDate() {
        return startDate;
    }

    public void setStartDate(LocalDate startDate) {
        this.startDate = startDate;
    }

    public LocalDate getEndDate() {
        return endDate;
    }

    public void setEndDate(LocalDate endDate) {
        this.endDate = endDate;
    }

    public Integer getMinPoints() {
        return minPoints;
    }

    public void setMinPoints(Integer minPoints) {
        this.minPoints = minPoints;
    }

    public Integer getMaxPoints() {
        return maxPoints;
    }

    public void setMaxPoints(Integer maxPoints) {
        this.maxPoints = maxPoints;
    }

}

package com.lureclub.points.entity.points.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * 积分详情响应VO（积分详情VO）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "积分详情信息")
public class PointsDetailVo {

    @Schema(description = "用户ID")
    private Long userId;

    @Schema(description = "用户名")
    private String username;

    @Schema(description = "手机号")
    private String phone;

    @Schema(description = "当日积分")
    private Integer todayPoints;

    @Schema(description = "有效积分")
    private Integer effectivePoints;

    @Schema(description = "总积分")
    private Integer totalPoints;

    @Schema(description = "最后积分更新日期")
    private LocalDate lastPointsDate;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public PointsDetailVo() {}

    public PointsDetailVo(Long userId, String username, String phone, Integer todayPoints,
                          Integer effectivePoints, Integer totalPoints, LocalDate lastPointsDate,
                          LocalDateTime createTime) {
        this.userId = userId;
        this.username = username;
        this.phone = phone;
        this.todayPoints = todayPoints;
        this.effectivePoints = effectivePoints;
        this.totalPoints = totalPoints;
        this.lastPointsDate = lastPointsDate;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public Integer getTodayPoints() {
        return todayPoints;
    }

    public void setTodayPoints(Integer todayPoints) {
        this.todayPoints = todayPoints;
    }

    public Integer getEffectivePoints() {
        return effectivePoints;
    }

    public void setEffectivePoints(Integer effectivePoints) {
        this.effectivePoints = effectivePoints;
    }

    public Integer getTotalPoints() {
        return totalPoints;
    }

    public void setTotalPoints(Integer totalPoints) {
        this.totalPoints = totalPoints;
    }

    public LocalDate getLastPointsDate() {
        return lastPointsDate;
    }

    public void setLastPointsDate(LocalDate lastPointsDate) {
        this.lastPointsDate = lastPointsDate;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.points.vo.response;

import com.lureclub.points.enums.PointsType;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * 积分历史响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "积分历史信息")
public class PointsHistoryVo {

    @Schema(description = "历史记录ID")
    private Long id;

    @Schema(description = "用户ID")
    private Long userId;

    @Schema(description = "积分类型")
    private PointsType pointsType;

    @Schema(description = "积分类型描述")
    private String pointsTypeDesc;

    @Schema(description = "积分数量")
    private Integer points;

    @Schema(description = "操作日期")
    private LocalDate operationDate;

    @Schema(description = "备注说明")
    private String remark;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public PointsHistoryVo() {}

    public PointsHistoryVo(Long id, Long userId, PointsType pointsType, Integer points,
                           LocalDate operationDate, String remark, LocalDateTime createTime) {
        this.id = id;
        this.userId = userId;
        this.pointsType = pointsType;
        this.pointsTypeDesc = pointsType != null ? pointsType.getDescription() : null;
        this.points = points;
        this.operationDate = operationDate;
        this.remark = remark;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public PointsType getPointsType() {
        return pointsType;
    }

    public void setPointsType(PointsType pointsType) {
        this.pointsType = pointsType;
        this.pointsTypeDesc = pointsType != null ? pointsType.getDescription() : null;
    }

    public String getPointsTypeDesc() {
        return pointsTypeDesc;
    }

    public void setPointsTypeDesc(String pointsTypeDesc) {
        this.pointsTypeDesc = pointsTypeDesc;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    public LocalDate getOperationDate() {
        return operationDate;
    }

    public void setOperationDate(LocalDate operationDate) {
        this.operationDate = operationDate;
    }

    public String getRemark() {
        return remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.points.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;

/**
 * 积分信息响应VO（含当日积分字段）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "积分信息")
public class PointsVo {

    @Schema(description = "用户ID")
    private Long userId;

    @Schema(description = "当日积分")
    private Integer todayPoints;

    @Schema(description = "有效积分")
    private Integer effectivePoints;

    @Schema(description = "总积分")
    private Integer totalPoints;

    @Schema(description = "最后积分更新日期")
    private LocalDate lastPointsDate;

    // 构造函数
    public PointsVo() {}

    public PointsVo(Long userId, Integer todayPoints, Integer effectivePoints, Integer totalPoints, LocalDate lastPointsDate) {
        this.userId = userId;
        this.todayPoints = todayPoints;
        this.effectivePoints = effectivePoints;
        this.totalPoints = totalPoints;
        this.lastPointsDate = lastPointsDate;
    }

    // Getter和Setter方法
    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public Integer getTodayPoints() {
        return todayPoints;
    }

    public void setTodayPoints(Integer todayPoints) {
        this.todayPoints = todayPoints;
    }

    public Integer getEffectivePoints() {
        return effectivePoints;
    }

    public void setEffectivePoints(Integer effectivePoints) {
        this.effectivePoints = effectivePoints;
    }

    public Integer getTotalPoints() {
        return totalPoints;
    }

    public void setTotalPoints(Integer totalPoints) {
        this.totalPoints = totalPoints;
    }

    public LocalDate getLastPointsDate() {
        return lastPointsDate;
    }

    public void setLastPointsDate(LocalDate lastPointsDate) {
        this.lastPointsDate = lastPointsDate;
    }

}

package com.lureclub.points.entity.points;

import jakarta.persistence.*;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * 积分实体类（包含有效积分、总积分）
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "points")
public class Points {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 用户ID
     */
    @Column(name = "user_id", nullable = false)
    private Long userId;

    /**
     * 当日积分
     */
    @Column(name = "today_points", nullable = false)
    private Integer todayPoints = 0;

    /**
     * 最后积分更新日期
     */
    @Column(name = "last_points_date")
    private LocalDate lastPointsDate;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    // 构造函数
    public Points() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
    }

    public Points(Long userId) {
        this();
        this.userId = userId;
    }

    // 核心方法

    /**
     * 处理当日积分转换
     * 当日积分次日自动转为有效积分
     */
    public void processDateChange() {
        LocalDate today = LocalDate.now();
        if (lastPointsDate != null && !lastPointsDate.equals(today)) {
            // 前一日积分转为有效积分，当日积分清零
            this.todayPoints = 0;
        }
        this.lastPointsDate = today;
        this.updateTime = LocalDateTime.now();
    }

    /**
     * 录入当日积分
     *
     * @param points 积分数量
     */
    public void addTodayPoints(Integer points) {
        if (points != null && points > 0) {
            this.todayPoints += points;
            this.lastPointsDate = LocalDate.now();
            this.updateTime = LocalDateTime.now();
        }
    }

    /**
     * 抵扣有效积分
     *
     * @param points 抵扣积分数量
     */
    public void deductEffectivePoints(Integer points) {
        if (points != null && points > 0) {
            this.updateTime = LocalDateTime.now();
        }
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public Integer getTodayPoints() {
        return todayPoints;
    }

    public void setTodayPoints(Integer todayPoints) {
        this.todayPoints = todayPoints;
    }

    public LocalDate getLastPointsDate() {
        return lastPointsDate;
    }

    public void setLastPointsDate(LocalDate lastPointsDate) {
        this.lastPointsDate = lastPointsDate;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}

package com.lureclub.points.entity.points;

import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;
import org.springframework.stereotype.Component;

/**
 * 积分转换器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class PointsConverter {

    /**
     * 将Points实体转换为PointsVo
     *
     * @param points 积分实体
     * @param effectivePoints 有效积分
     * @param totalPoints 总积分
     * @return 积分VO
     */
    public PointsVo toPointsVo(Points points, Integer effectivePoints, Integer totalPoints) {
        if (points == null) {
            return null;
        }
        return new PointsVo(
                points.getUserId(),
                points.getTodayPoints(),
                effectivePoints != null ? effectivePoints : 0,
                totalPoints != null ? totalPoints : 0,
                points.getLastPointsDate()
        );
    }

    /**
     * 将PointsHistory实体转换为PointsHistoryVo
     *
     * @param history 积分历史实体
     * @return 积分历史VO
     */
    public PointsHistoryVo toPointsHistoryVo(PointsHistory history) {
        if (history == null) {
            return null;
        }
        return new PointsHistoryVo(
                history.getId(),
                history.getUserId(),
                history.getPointsType(),
                history.getPoints(),
                history.getOperationDate(),
                history.getRemark(),
                history.getCreateTime()
        );
    }

}

package com.lureclub.points.entity.points;

import com.lureclub.points.enums.PointsType;
import jakarta.persistence.*;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * 积分历史实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "points_history")
public class PointsHistory {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 用户ID
     */
    @Column(name = "user_id", nullable = false)
    private Long userId;

    /**
     * 积分类型
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "points_type", nullable = false)
    private PointsType pointsType;

    /**
     * 积分数量（正数为获得，负数为抵扣）
     */
    @Column(name = "points", nullable = false)
    private Integer points;

    /**
     * 操作日期
     */
    @Column(name = "operation_date", nullable = false)
    private LocalDate operationDate;

    /**
     * 备注说明
     */
    @Column(name = "remark", length = 500)
    private String remark;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    // 构造函数
    public PointsHistory() {
        this.createTime = LocalDateTime.now();
        this.operationDate = LocalDate.now();
    }

    public PointsHistory(Long userId, PointsType pointsType, Integer points, String remark) {
        this();
        this.userId = userId;
        this.pointsType = pointsType;
        this.points = points;
        this.remark = remark;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public PointsType getPointsType() {
        return pointsType;
    }

    public void setPointsType(PointsType pointsType) {
        this.pointsType = pointsType;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    public LocalDate getOperationDate() {
        return operationDate;
    }

    public void setOperationDate(LocalDate operationDate) {
        this.operationDate = operationDate;
    }

    public String getRemark() {
        return remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.prize.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;

/**
 * 奖品创建请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "奖品创建请求参数")
public class PrizeCreateVo {

    @Schema(description = "奖品名称", example = "钓鱼竿套装")
    @NotBlank(message = "奖品名称不能为空")
    private String name;

    @Schema(description = "奖品描述", example = "高品质碳素钓鱼竿，适合路亚钓法")
    @NotBlank(message = "奖品描述不能为空")
    private String description;

    @Schema(description = "排序序号", example = "1")
    private Integer sortOrder = 0;

    // 构造函数
    public PrizeCreateVo() {}

    public PrizeCreateVo(String name, String description, Integer sortOrder) {
        this.name = name;
        this.description = description;
        this.sortOrder = sortOrder;
    }

    // Getter和Setter方法
    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

}

package com.lureclub.points.entity.prize.vo.request;

public class PrizeSearchVo {
}


package com.lureclub.points.entity.prize.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 奖品更新请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "奖品更新请求参数")
public class PrizeUpdateVo {

    @Schema(description = "奖品名称", example = "钓鱼竿套装")
    private String name;

    @Schema(description = "奖品描述", example = "高品质碳素钓鱼竿，适合路亚钓法")
    private String description;

    @Schema(description = "排序序号", example = "1")
    private Integer sortOrder;

    @Schema(description = "是否启用", example = "true")
    private Boolean isEnabled;

    // 构造函数
    public PrizeUpdateVo() {}

    public PrizeUpdateVo(String name, String description, Integer sortOrder, Boolean isEnabled) {
        this.name = name;
        this.description = description;
        this.sortOrder = sortOrder;
        this.isEnabled = isEnabled;
    }

    // Getter和Setter方法
    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

    public Boolean getIsEnabled() {
        return isEnabled;
    }

    public void setIsEnabled(Boolean isEnabled) {
        this.isEnabled = isEnabled;
    }

}

package com.lureclub.points.entity.prize.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 奖品列表响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "奖品列表信息")
public class PrizeListVo {

    @Schema(description = "奖品ID")
    private Long id;

    @Schema(description = "奖品名称")
    private String name;

    @Schema(description = "奖品描述摘要（前100个字符）")
    private String summary;

    @Schema(description = "奖品图片URL")
    private String imageUrl;

    @Schema(description = "排序序号")
    private Integer sortOrder;

    // 构造函数
    public PrizeListVo() {}

    public PrizeListVo(Long id, String name, String description, String imageUrl, Integer sortOrder) {
        this.id = id;
        this.name = name;
        this.imageUrl = imageUrl;
        this.sortOrder = sortOrder;
        // 生成摘要，最多100个字符
        if (description != null) {
            this.summary = description.length() > 100 ? description.substring(0, 100) + "..." : description;
        }
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getSummary() {
        return summary;
    }

    public void setSummary(String summary) {
        this.summary = summary;
    }

    public String getImageUrl() {
        return imageUrl;
    }

    public void setImageUrl(String imageUrl) {
        this.imageUrl = imageUrl;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

}

package com.lureclub.points.entity.prize.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;

/**
 * 奖品详情响应VO（含图片URL）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "奖品详情信息")
public class PrizeVo {

    @Schema(description = "奖品ID")
    private Long id;

    @Schema(description = "奖品名称")
    private String name;

    @Schema(description = "奖品描述")
    private String description;

    @Schema(description = "奖品图片URL")
    private String imageUrl;

    @Schema(description = "排序序号")
    private Integer sortOrder;

    @Schema(description = "是否启用")
    private Boolean isEnabled;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public PrizeVo() {}

    public PrizeVo(Long id, String name, String description, String imageUrl,
                   Integer sortOrder, Boolean isEnabled, LocalDateTime createTime) {
        this.id = id;
        this.name = name;
        this.description = description;
        this.imageUrl = imageUrl;
        this.sortOrder = sortOrder;
        this.isEnabled = isEnabled;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public String getImageUrl() {
        return imageUrl;
    }

    public void setImageUrl(String imageUrl) {
        this.imageUrl = imageUrl;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

    public Boolean getIsEnabled() {
        return isEnabled;
    }

    public void setIsEnabled(Boolean isEnabled) {
        this.isEnabled = isEnabled;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.prize;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import java.time.LocalDateTime;

/**
 * 奖品实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "prizes")
public class Prize {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 奖品名称
     */
    @Column(nullable = false, length = 200)
    @NotBlank(message = "奖品名称不能为空")
    private String name;

    /**
     * 奖品描述
     */
    @Column(nullable = false, columnDefinition = "TEXT")
    @NotBlank(message = "奖品描述不能为空")
    private String description;

    /**
     * 奖品图片URL
     */
    @Column(name = "image_url", length = 500)
    private String imageUrl;

    /**
     * 排序序号
     */
    @Column(name = "sort_order", nullable = false)
    private Integer sortOrder = 0;

    /**
     * 是否启用
     */
    @Column(name = "is_enabled", nullable = false)
    private Boolean isEnabled = true;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * 是否删除 (0:未删除 1:已删除)
     */
    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0;

    // 构造函数
    public Prize() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
    }

    public Prize(String name, String description) {
        this();
        this.name = name;
        this.description = description;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public String getImageUrl() {
        return imageUrl;
    }

    public void setImageUrl(String imageUrl) {
        this.imageUrl = imageUrl;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

    public Boolean getIsEnabled() {
        return isEnabled;
    }

    public void setIsEnabled(Boolean isEnabled) {
        this.isEnabled = isEnabled;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    public Integer getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(Integer isDeleted) {
        this.isDeleted = isDeleted;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}

package com.lureclub.points.entity.prize;

import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.prize.vo.response.PrizeListVo;
import org.springframework.stereotype.Component;

/**
 * 奖品转换器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class PrizeConverter {

    /**
     * 将Prize实体转换为PrizeVo
     *
     * @param prize 奖品实体
     * @return 奖品VO
     */
    public PrizeVo toPrizeVo(Prize prize) {
        if (prize == null) {
            return null;
        }
        return new PrizeVo(
                prize.getId(),
                prize.getName(),
                prize.getDescription(),
                prize.getImageUrl(),
                prize.getSortOrder(),
                prize.getIsEnabled(),
                prize.getCreateTime()
        );
    }

    /**
     * 将Prize实体转换为PrizeListVo
     *
     * @param prize 奖品实体
     * @return 奖品列表VO
     */
    public PrizeListVo toPrizeListVo(Prize prize) {
        if (prize == null) {
            return null;
        }
        return new PrizeListVo(
                prize.getId(),
                prize.getName(),
                prize.getDescription(),
                prize.getImageUrl(),
                prize.getSortOrder()
        );
    }

}

package com.lureclub.points.entity.ranking.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 排行榜详细项目响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "排行榜详细项目信息")
public class RankingDetailVo {

    @Schema(description = "排名")
    private Integer rank;

    @Schema(description = "用户ID")
    private Long userId;

    @Schema(description = "用户名")
    private String username;

    @Schema(description = "手机号（脱敏）")
    private String maskedPhone;

    @Schema(description = "积分数量")
    private Integer points;

    @Schema(description = "与前一名的积分差距")
    private Integer pointsDiff;

    @Schema(description = "排名变化（相比上次排名）")
    private Integer rankChange;

    // 构造函数
    public RankingDetailVo() {}

    public RankingDetailVo(Integer rank, Long userId, String username, String maskedPhone,
                           Integer points, Integer pointsDiff, Integer rankChange) {
        this.rank = rank;
        this.userId = userId;
        this.username = username;
        this.maskedPhone = maskedPhone;
        this.points = points;
        this.pointsDiff = pointsDiff;
        this.rankChange = rankChange;
    }

    // Getter和Setter方法
    public Integer getRank() {
        return rank;
    }

    public void setRank(Integer rank) {
        this.rank = rank;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getMaskedPhone() {
        return maskedPhone;
    }

    public void setMaskedPhone(String maskedPhone) {
        this.maskedPhone = maskedPhone;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    public Integer getPointsDiff() {
        return pointsDiff;
    }

    public void setPointsDiff(Integer pointsDiff) {
        this.pointsDiff = pointsDiff;
    }

    public Integer getRankChange() {
        return rankChange;
    }

    public void setRankChange(Integer rankChange) {
        this.rankChange = rankChange;
    }

}

package com.lureclub.points.entity.ranking.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 排行榜项目响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "排行榜项目信息")
public class RankingItemVo {

    @Schema(description = "排名")
    private Integer rank;

    @Schema(description = "用户ID")
    private Long userId;

    @Schema(description = "用户名")
    private String username;

    @Schema(description = "积分数量")
    private Integer points;

    // 构造函数
    public RankingItemVo() {}

    public RankingItemVo(Integer rank, Long userId, String username, Integer points) {
        this.rank = rank;
        this.userId = userId;
        this.username = username;
        this.points = points;
    }

    // Getter和Setter方法
    public Integer getRank() {
        return rank;
    }

    public void setRank(Integer rank) {
        this.rank = rank;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

}

package com.lureclub.points.entity.ranking.vo.response;

import com.lureclub.points.enums.RankingType;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.util.List;

/**
 * 排行榜响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "排行榜信息")
public class RankingVo {

    @Schema(description = "排行榜类型")
    private RankingType rankingType;

    @Schema(description = "排行榜类型描述")
    private String rankingTypeDesc;

    @Schema(description = "统计日期")
    private LocalDate statisticsDate;

    @Schema(description = "排行榜列表")
    private List<RankingItemVo> rankingList;

    // 构造函数
    public RankingVo() {}

    public RankingVo(RankingType rankingType, LocalDate statisticsDate, List<RankingItemVo> rankingList) {
        this.rankingType = rankingType;
        this.rankingTypeDesc = rankingType != null ? rankingType.getDescription() : null;
        this.statisticsDate = statisticsDate;
        this.rankingList = rankingList;
    }

    // Getter和Setter方法
    public RankingType getRankingType() {
        return rankingType;
    }

    public void setRankingType(RankingType rankingType) {
        this.rankingType = rankingType;
        this.rankingTypeDesc = rankingType != null ? rankingType.getDescription() : null;
    }

    public String getRankingTypeDesc() {
        return rankingTypeDesc;
    }

    public void setRankingTypeDesc(String rankingTypeDesc) {
        this.rankingTypeDesc = rankingTypeDesc;
    }

    public LocalDate getStatisticsDate() {
        return statisticsDate;
    }

    public void setStatisticsDate(LocalDate statisticsDate) {
        this.statisticsDate = statisticsDate;
    }

    public List<RankingItemVo> getRankingList() {
        return rankingList;
    }

    public void setRankingList(List<RankingItemVo> rankingList) {
        this.rankingList = rankingList;
    }

}

package com.lureclub.points.entity.ranking;

public class RankingConverter {
}

package com.lureclub.points.entity.user.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;

/**
 * 用户创建请求VO（管理员用）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "用户创建请求参数")
public class UserCreateVo {

    @Schema(description = "用户名", example = "testuser")
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 20, message = "用户名长度必须在3-20个字符之间")
    private String username;

    @Schema(description = "密码", example = "123456")
    @NotBlank(message = "密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度必须在6-20个字符之间")
    private String password;

    @Schema(description = "手机号", example = "13800138000")
    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    // 构造函数
    public UserCreateVo() {}

    public UserCreateVo(String username, String password, String phone) {
        this.username = username;
        this.password = password;
        this.phone = phone;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

}

package com.lureclub.points.entity.user.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;

/**
 * 用户登录请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "用户登录请求参数")
public class UserLoginVo {

    /**
     * 用户名或手机号
     */
    @Schema(description = "用户名或手机号", example = "testuser")
    @NotBlank(message = "用户名或手机号不能为空")
    private String username;

    /**
     * 密码
     */
    @Schema(description = "密码", example = "123456")
    @NotBlank(message = "密码不能为空")
    private String password;

    // 构造函数
    public UserLoginVo() {}

    public UserLoginVo(String username, String password) {
        this.username = username;
        this.password = password;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

}

package com.lureclub.points.entity.user.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;

/**
 * 用户注册请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "用户注册请求参数")
public class UserRegisterVo {

    /**
     * 用户名
     */
    @Schema(description = "用户名", example = "testuser")
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 20, message = "用户名长度必须在3-20个字符之间")
    private String username;

    /**
     * 密码
     */
    @Schema(description = "密码", example = "123456")
    @NotBlank(message = "密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度必须在6-20个字符之间")
    private String password;

    /**
     * 确认密码
     */
    @Schema(description = "确认密码", example = "123456")
    @NotBlank(message = "确认密码不能为空")
    private String confirmPassword;

    /**
     * 手机号
     */
    @Schema(description = "手机号", example = "13800138000")
    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    // 构造函数
    public UserRegisterVo() {}

    public UserRegisterVo(String username, String password, String confirmPassword, String phone) {
        this.username = username;
        this.password = password;
        this.confirmPassword = confirmPassword;
        this.phone = phone;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getConfirmPassword() {
        return confirmPassword;
    }

    public void setConfirmPassword(String confirmPassword) {
        this.confirmPassword = confirmPassword;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

}

package com.lureclub.points.entity.user.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 用户搜索请求VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "用户搜索请求参数")
public class UserSearchVo {

    @Schema(description = "用户名关键词", example = "test")
    private String username;

    @Schema(description = "手机号关键词", example = "138")
    private String phone;

    // 构造函数
    public UserSearchVo() {}

    public UserSearchVo(String username, String phone) {
        this.username = username;
        this.phone = phone;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

}

package com.lureclub.points.entity.user.vo.request;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;

/**
 * 用户更新请求VO（管理员用）
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "用户更新请求参数")
public class UserUpdateVo {

    @Schema(description = "用户名", example = "testuser")
    @Size(min = 3, max = 20, message = "用户名长度必须在3-20个字符之间")
    private String username;

    @Schema(description = "密码", example = "123456")
    @Size(min = 6, max = 20, message = "密码长度必须在6-20个字符之间")
    private String password;

    @Schema(description = "手机号", example = "13800138000")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    // 构造函数
    public UserUpdateVo() {}

    public UserUpdateVo(String username, String password, String phone) {
        this.username = username;
        this.password = password;
        this.phone = phone;
    }

    // Getter和Setter方法
    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

}

package com.lureclub.points.entity.user.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;

/**
 * 登录响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "登录响应信息")
public class LoginVo {

    @Schema(description = "访问令牌")
    private String token;

    @Schema(description = "令牌类型", example = "Bearer")
    private String tokenType = "Bearer";

    @Schema(description = "用户信息")
    private UserVo userInfo;

    // 构造函数
    public LoginVo() {}

    public LoginVo(String token, UserVo userInfo) {
        this.token = token;
        this.userInfo = userInfo;
    }

    public LoginVo(String token, String tokenType, UserVo userInfo) {
        this.token = token;
        this.tokenType = tokenType;
        this.userInfo = userInfo;
    }

    // Getter和Setter方法
    public String getToken() {
        return token;
    }

    public void setToken(String token) {
        this.token = token;
    }

    public String getTokenType() {
        return tokenType;
    }

    public void setTokenType(String tokenType) {
        this.tokenType = tokenType;
    }

    public UserVo getUserInfo() {
        return userInfo;
    }

    public void setUserInfo(UserVo userInfo) {
        this.userInfo = userInfo;
    }

}

package com.lureclub.points.entity.user.vo.response;

import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;

/**
 * 用户信息响应VO
 *
 * @author system
 * @date 2025-06-19
 */
@Schema(description = "用户信息")
public class UserVo {

    @Schema(description = "用户ID")
    private Long id;

    @Schema(description = "用户名")
    private String username;

    @Schema(description = "手机号")
    private String phone;

    @Schema(description = "创建时间")
    private LocalDateTime createTime;

    // 构造函数
    public UserVo() {}

    public UserVo(Long id, String username, String phone, LocalDateTime createTime) {
        this.id = id;
        this.username = username;
        this.phone = phone;
        this.createTime = createTime;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

}

package com.lureclub.points.entity.user;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import java.time.LocalDateTime;

/**
 * 用户实体类
 *
 * @author system
 * @date 2025-06-19
 */
@Entity
@Table(name = "users")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * 用户名
     */
    @Column(unique = true, nullable = false, length = 50)
    @NotBlank(message = "用户名不能为空")
    private String username;

    /**
     * 密码
     */
    @Column(nullable = false, length = 255)
    @NotBlank(message = "密码不能为空")
    private String password;

    /**
     * 手机号
     */
    @Column(unique = true, nullable = false, length = 11)
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    /**
     * 创建时间
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * 更新时间
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * 是否删除 (0:未删除 1:已删除)
     */
    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0;

    // 构造函数
    public User() {
        this.createTime = LocalDateTime.now();
        this.updateTime = LocalDateTime.now();
    }

    public User(String username, String password, String phone) {
        this();
        this.username = username;
        this.password = password;
        this.phone = phone;
    }

    // Getter和Setter方法
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getUpdateTime() {
        return updateTime;
    }

    public void setUpdateTime(LocalDateTime updateTime) {
        this.updateTime = updateTime;
    }

    public Integer getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(Integer isDeleted) {
        this.isDeleted = isDeleted;
    }

    @PreUpdate
    public void preUpdate() {
        this.updateTime = LocalDateTime.now();
    }

}

package com.lureclub.points.entity.user;

import com.lureclub.points.entity.user.vo.response.UserVo;
import org.springframework.stereotype.Component;

/**
 * 用户转换器
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class UserConverter {

    /**
     * 将User实体转换为UserVo
     *
     * @param user 用户实体
     * @return 用户VO
     */
    public UserVo toUserVo(User user) {
        if (user == null) {
            return null;
        }
        return new UserVo(
                user.getId(),
                user.getUsername(),
                user.getPhone(),
                user.getCreateTime()
        );
    }

    /**
     * 将User实体转换为UserVo（脱敏手机号）
     *
     * @param user 用户实体
     * @return 用户VO（手机号脱敏）
     */
    public UserVo toUserVoWithMaskedPhone(User user) {
        if (user == null) {
            return null;
        }

        String maskedPhone = maskPhone(user.getPhone());
        return new UserVo(
                user.getId(),
                user.getUsername(),
                maskedPhone,
                user.getCreateTime()
        );
    }

    /**
     * 手机号脱敏
     *
     * @param phone 手机号
     * @return 脱敏后的手机号
     */
    private String maskPhone(String phone) {
        if (phone == null || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }

}

package com.lureclub.points.enums;

/**
 * 留言状态枚举
 *
 * @author system
 * @date 2025-06-19
 */
public enum MessageStatus {

    /**
     * 待审核
     */
    PENDING("待审核"),

    /**
     * 已公开
     */
    PUBLISHED("已公开"),

    /**
     * 已回复
     */
    REPLIED("已回复"),

    /**
     * 已隐藏
     */
    HIDDEN("已隐藏");

    private final String description;

    MessageStatus(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }

}

package com.lureclub.points.enums;

/**
 * 积分类型枚举
 *
 * @author system
 * @date 2025-06-19
 */
public enum PointsType {

    /**
     * 类型1: 获得积分（管理员录入）
     */
    EARNED("获得积分"),

    /**
     * 类型2: 抵扣积分（管理员抵扣操作）
     */
    DEDUCTED("抵扣积分"),

    /**
     * 类型3: 管理员调整
     */
    ADMIN_ADJUSTMENT("管理员调整");

    private final String description;

    PointsType(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }

}

package com.lureclub.points.enums;

/**
 * 排行榜类型枚举
 *
 * @author system
 * @date 2025-06-19
 */
public enum RankingType {

    /**
     * 当日排行榜
     */
    DAILY("当日排行榜"),

    /**
     * 本周排行榜
     */
    WEEKLY("本周排行榜"),

    /**
     * 总排行榜
     */
    TOTAL("总排行榜");

    private final String description;

    RankingType(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }

}

package com.lureclub.points.enums;

/**
 * 用户角色枚举
 *
 * @author system
 * @date 2025-06-19
 */
public enum UserRole {

    /**
     * 普通用户
     */
    USER("普通用户"),

    /**
     * 管理员
     */
    ADMIN("管理员");

    private final String description;

    UserRole(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }

}


package com.lureclub.points.exception;

/**
 * 业务异常类
 *
 * @author system
 * @date 2025-06-19
 */
public class BusinessException extends RuntimeException {

    private Integer code;

    public BusinessException(String message) {
        super(message);
        this.code = 500;
    }

    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }

    public BusinessException(String message, Throwable cause) {
        super(message, cause);
        this.code = 500;
    }

    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

}


package com.lureclub.points.exception;

import com.lureclub.points.entity.common.ApiResponse;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.BindException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.stream.Collectors;

/**
 * 全局异常处理器
 *
 * @author system
 * @date 2025-06-19
 */
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * 业务异常处理
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Object>> handleBusinessException(BusinessException e) {
        ApiResponse<Object> response = ApiResponse.error(e.getCode(), e.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * 参数校验异常处理 - @Valid注解
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Object>> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));

        ApiResponse<Object> response = ApiResponse.error(400, "参数校验失败: " + message);
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * 参数绑定异常处理
     */
    @ExceptionHandler(BindException.class)
    public ResponseEntity<ApiResponse<Object>> handleBindException(BindException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));

        ApiResponse<Object> response = ApiResponse.error(400, "参数绑定失败: " + message);
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * 非法参数异常处理
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<ApiResponse<Object>> handleIllegalArgumentException(IllegalArgumentException e) {
        ApiResponse<Object> response = ApiResponse.error(400, "参数错误: " + e.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * 用户未找到异常处理
     */
    @ExceptionHandler(UserNotFoundException.class)
    public ResponseEntity<ApiResponse<Object>> handleUserNotFoundException(UserNotFoundException e) {
        ApiResponse<Object> response = ApiResponse.error(404, e.getMessage());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }

    /**
     * 积分不足异常处理
     */
    @ExceptionHandler(InsufficientPointsException.class)
    public ResponseEntity<ApiResponse<Object>> handleInsufficientPointsException(InsufficientPointsException e) {
        ApiResponse<Object> response = ApiResponse.error(400, e.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * 未授权异常处理
     */
    @ExceptionHandler(UnauthorizedException.class)
    public ResponseEntity<ApiResponse<Object>> handleUnauthorizedException(UnauthorizedException e) {
        ApiResponse<Object> response = ApiResponse.error(401, e.getMessage());
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(response);
    }

    /**
     * 通用异常处理
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Object>> handleGenericException(Exception e) {
        e.printStackTrace(); // 打印异常信息用于调试
        ApiResponse<Object> response = ApiResponse.error(500, "系统内部错误: " + e.getMessage());
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }

}

package com.lureclub.points.exception;

/**
 * 积分不足异常
 *
 * @author system
 * @date 2025-06-19
 */
public class InsufficientPointsException extends RuntimeException {

    public InsufficientPointsException(String message) {
        super(message);
    }

    public InsufficientPointsException(String message, Throwable cause) {
        super(message, cause);
    }

}

package com.lureclub.points.exception;

/**
 * 未授权异常
 *
 * @author system
 * @date 2025-06-19
 */
public class UnauthorizedException extends RuntimeException {

    public UnauthorizedException(String message) {
        super(message);
    }

    public UnauthorizedException(String message, Throwable cause) {
        super(message, cause);
    }

}

package com.lureclub.points.exception;

/**
 * 用户未找到异常
 *
 * @author system
 * @date 2025-06-19
 */
public class UserNotFoundException extends RuntimeException {

    public UserNotFoundException(String message) {
        super(message);
    }

    public UserNotFoundException(String message, Throwable cause) {
        super(message, cause);
    }

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.admin.Admin;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * 管理员数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface AdminRepository extends JpaRepository<Admin, Long> {

    /**
     * 根据用户名查找管理员
     *
     * @param username 用户名
     * @return 管理员信息
     */
    Admin findByUsername(String username);

    /**
     * 检查用户名是否存在
     *
     * @param username 用户名
     * @return 是否存在
     */
    boolean existsByUsername(String username);

    /**
     * 查找所有未删除的管理员
     *
     * @return 管理员列表
     */
    @Query("SELECT a FROM Admin a WHERE a.isDeleted = 0 ORDER BY a.createTime DESC")
    List<Admin> findAllActive();

    /**
     * 根据ID查找未删除的管理员
     *
     * @param id 管理员ID
     * @return 管理员信息
     */
    @Query("SELECT a FROM Admin a WHERE a.id = :id AND a.isDeleted = 0")
    Optional<Admin> findActiveAdminById(Long id);

    /**
     * 查找所有启用的管理员
     *
     * @return 管理员列表
     */
    @Query("SELECT a FROM Admin a WHERE a.isDeleted = 0 AND a.isEnabled = true ORDER BY a.createTime DESC")
    List<Admin> findAllEnabled();

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.announcement.Announcement;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.List;

/**
 * 公告数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface AnnouncementRepository extends JpaRepository<Announcement, Long> {

    /**
     * 查找未删除的公告，按置顶和发布日期排序
     *
     * @return 公告列表
     */
    @Query("SELECT a FROM Announcement a WHERE a.isDeleted = 0 ORDER BY a.isTop DESC, a.publishDate DESC, a.createTime DESC")
    List<Announcement> findAllActiveOrderByTopAndDate();

    /**
     * 根据ID和删除状态查找公告
     *
     * @param id 公告ID
     * @param isDeleted 删除状态
     * @return 公告
     */
    Announcement findByIdAndIsDeleted(Long id, Integer isDeleted);

    /**
     * 根据日期范围查找公告
     *
     * @param startDate 开始日期
     * @param endDate 结束日期
     * @return 公告列表
     */
    @Query("SELECT a FROM Announcement a WHERE a.isDeleted = 0 " +
            "AND (:startDate IS NULL OR a.publishDate >= :startDate) " +
            "AND (:endDate IS NULL OR a.publishDate <= :endDate) " +
            "ORDER BY a.isTop DESC, a.publishDate DESC")
    List<Announcement> findByDateRange(@Param("startDate") LocalDate startDate,
                                       @Param("endDate") LocalDate endDate);

    /**
     * 根据关键词搜索公告（标题或内容）
     *
     * @param keyword 关键词
     * @return 公告列表
     */
    @Query("SELECT a FROM Announcement a WHERE a.isDeleted = 0 " +
            "AND (a.title LIKE %:keyword% OR a.content LIKE %:keyword%) " +
            "ORDER BY a.isTop DESC, a.publishDate DESC")
    List<Announcement> findByKeyword(@Param("keyword") String keyword);

    /**
     * 查找所有置顶公告
     *
     * @return 置顶公告列表
     */
    @Query("SELECT a FROM Announcement a WHERE a.isDeleted = 0 AND a.isTop = true " +
            "ORDER BY a.publishDate DESC, a.createTime DESC")
    List<Announcement> findTopAnnouncements();

    /**
     * 查找所有未删除的公告（管理员用）
     *
     * @return 公告列表
     */
    @Query("SELECT a FROM Announcement a WHERE a.isDeleted = 0 ORDER BY a.createTime DESC")
    List<Announcement> findAllActive();

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.message.MessageReply;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * 留言回复数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface MessageReplyRepository extends JpaRepository<MessageReply, Long> {

    /**
     * 根据留言ID查找所有回复
     *
     * @param messageId 留言ID
     * @param isDeleted 删除状态
     * @return 回复列表
     */
    @Query("SELECT mr FROM MessageReply mr WHERE mr.messageId = :messageId AND mr.isDeleted = :isDeleted ORDER BY mr.createTime ASC")
    List<MessageReply> findAllByMessageIdAndIsDeleted(@Param("messageId") Long messageId, @Param("isDeleted") Integer isDeleted);

    /**
     * 根据留言ID列表查找所有可见回复
     *
     * @param messageIds 留言ID列表
     * @return 回复列表
     */
    @Query("SELECT mr FROM MessageReply mr WHERE mr.messageId IN :messageIds AND mr.isDeleted = 0 AND mr.isVisible = true ORDER BY mr.createTime ASC")
    List<MessageReply> findVisibleRepliesByMessageIds(@Param("messageIds") List<Long> messageIds);

    /**
     * 根据留言ID列表查找所有回复（管理员用）
     *
     * @param messageIds 留言ID列表
     * @return 回复列表
     */
    @Query("SELECT mr FROM MessageReply mr WHERE mr.messageId IN :messageIds AND mr.isDeleted = 0 ORDER BY mr.createTime ASC")
    List<MessageReply> findAllRepliesByMessageIds(@Param("messageIds") List<Long> messageIds);

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.message.Message;
import com.lureclub.points.enums.MessageStatus;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * 留言数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface MessageRepository extends JpaRepository<Message, Long> {

    /**
     * 查找所有公开的留言（用户端）
     *
     * @return 留言列表
     */
    @Query("SELECT m FROM Message m WHERE m.isDeleted = 0 AND (m.status = 'PUBLISHED' OR m.status = 'REPLIED') ORDER BY m.createTime DESC")
    List<Message> findPublicMessages();

    /**
     * 根据ID和删除状态查找留言
     *
     * @param id 留言ID
     * @param isDeleted 删除状态
     * @return 留言
     */
    Message findByIdAndIsDeleted(Long id, Integer isDeleted);

    /**
     * 查找所有未删除的留言，按创建时间倒序（管理员用）
     *
     * @return 留言列表
     */
    @Query("SELECT m FROM Message m WHERE m.isDeleted = 0 ORDER BY m.createTime DESC")
    List<Message> findAllActiveOrderByCreateTime();

    /**
     * 根据用户ID查找留言
     *
     * @param userId 用户ID
     * @return 留言列表
     */
    @Query("SELECT m FROM Message m WHERE m.userId = :userId AND m.isDeleted = 0 ORDER BY m.createTime DESC")
    List<Message> findByUserIdAndNotDeleted(@Param("userId") Long userId);

    /**
     * 根据状态查找留言
     *
     * @param status 留言状态
     * @return 留言列表
     */
    @Query("SELECT m FROM Message m WHERE m.status = :status AND m.isDeleted = 0 ORDER BY m.createTime DESC")
    List<Message> findByStatusAndNotDeleted(@Param("status") MessageStatus status);

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.points.PointsHistory;
import com.lureclub.points.enums.PointsType;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.List;

/**
 * 积分历史数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface PointsHistoryRepository extends JpaRepository<PointsHistory, Long> {

    /**
     * 根据用户ID查找积分历史（按日期倒序）
     *
     * @param userId 用户ID
     * @return 积分历史列表
     */
    @Query("SELECT ph FROM PointsHistory ph WHERE ph.userId = :userId ORDER BY ph.operationDate DESC, ph.createTime DESC")
    List<PointsHistory> findByUserIdOrderByOperationDateDescCreateTimeDesc(@Param("userId") Long userId);

    /**
     * 根据用户ID和积分类型查找积分历史
     *
     * @param userId 用户ID
     * @param pointsType 积分类型
     * @return 积分历史列表
     */
    List<PointsHistory> findByUserIdAndPointsTypeOrderByOperationDateDesc(Long userId, PointsType pointsType);

    /**
     * 根据操作日期范围查找积分历史
     *
     * @param userId 用户ID
     * @param startDate 开始日期
     * @param endDate 结束日期
     * @return 积分历史列表
     */
    @Query("SELECT ph FROM PointsHistory ph WHERE ph.userId = :userId AND ph.operationDate BETWEEN :startDate AND :endDate ORDER BY ph.operationDate DESC")
    List<PointsHistory> findByUserIdAndDateRange(@Param("userId") Long userId,
                                                 @Param("startDate") LocalDate startDate,
                                                 @Param("endDate") LocalDate endDate);

    /**
     * 计算用户总积分（所有获得积分的总和）
     *
     * @param userId 用户ID
     * @return 总积分
     */
    @Query("SELECT COALESCE(SUM(ph.points), 0) FROM PointsHistory ph WHERE ph.userId = :userId AND ph.points > 0")
    Integer calculateTotalPoints(@Param("userId") Long userId);

    /**
     * 计算用户有效积分（获得积分 - 抵扣积分，排除当日积分）
     *
     * @param userId 用户ID
     * @param today 今天日期
     * @return 有效积分
     */
    @Query("SELECT COALESCE(SUM(ph.points), 0) FROM PointsHistory ph WHERE ph.userId = :userId AND ph.operationDate < :today")
    Integer calculateEffectivePoints(@Param("userId") Long userId, @Param("today") LocalDate today);

    /**
     * 获取所有用户积分历史用于排行榜
     *
     * @return 积分历史列表
     */
    @Query("SELECT ph FROM PointsHistory ph ORDER BY ph.userId, ph.operationDate DESC")
    List<PointsHistory> findAllForRanking();

    /**
     * 获取指定日期范围内所有用户的积分历史
     *
     * @param startDate 开始日期
     * @param endDate 结束日期
     * @return 积分历史列表
     */
    @Query("SELECT ph FROM PointsHistory ph WHERE ph.operationDate BETWEEN :startDate AND :endDate ORDER BY ph.userId, ph.operationDate DESC")
    List<PointsHistory> findAllByDateRange(@Param("startDate") LocalDate startDate, @Param("endDate") LocalDate endDate);

    /**
     * 根据用户ID和日期范围查找积分历史（支持开放式查询）
     *
     * @param userId 用户ID
     * @param startDate 开始日期（可为null）
     * @param endDate 结束日期（可为null）
     * @return 积分历史列表
     */
    @Query("SELECT ph FROM PointsHistory ph WHERE ph.userId = :userId " +
            "AND (:startDate IS NULL OR ph.operationDate >= :startDate) " +
            "AND (:endDate IS NULL OR ph.operationDate <= :endDate) " +
            "ORDER BY ph.operationDate DESC")
    List<PointsHistory> findByUserIdAndDateRange(@Param("userId") Long userId,
                                                 @Param("startDate") LocalDate startDate,
                                                 @Param("endDate") LocalDate endDate);

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.points.Points;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.List;

/**
 * 积分数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface PointsRepository extends JpaRepository<Points, Long> {

    /**
     * 根据用户ID查找积分记录
     *
     * @param userId 用户ID
     * @return 积分记录
     */
    Points findByUserId(Long userId);

    /**
     * 查找所有用户的积分记录
     *
     * @return 积分记录列表
     */
    @Query("SELECT p FROM Points p ORDER BY p.userId")
    List<Points> findAllOrderByUserId();

    /**
     * 查找需要处理日期变更的积分记录
     *
     * @param today 今天日期
     * @return 需要处理的积分记录列表
     */
    @Query("SELECT p FROM Points p WHERE p.lastPointsDate IS NULL OR p.lastPointsDate < :today")
    List<Points> findPointsNeedDateProcessing(@Param("today") LocalDate today);

    /**
     * 检查用户是否有积分记录
     *
     * @param userId 用户ID
     * @return 是否存在
     */
    boolean existsByUserId(Long userId);

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.prize.Prize;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * 奖品数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface PrizeRepository extends JpaRepository<Prize, Long> {

    /**
     * 查找所有启用且未删除的奖品，按排序序号排序
     *
     * @return 奖品列表
     */
    @Query("SELECT p FROM Prize p WHERE p.isDeleted = 0 AND p.isEnabled = true ORDER BY p.sortOrder ASC, p.createTime DESC")
    List<Prize> findAllActiveOrderBySortOrder();

    /**
     * 根据ID、删除状态和启用状态查找奖品
     *
     * @param id 奖品ID
     * @param isDeleted 删除状态
     * @param isEnabled 启用状态
     * @return 奖品
     */
    Prize findByIdAndIsDeletedAndIsEnabled(Long id, Integer isDeleted, Boolean isEnabled);

    /**
     * 根据ID和删除状态查找奖品
     *
     * @param id 奖品ID
     * @param isDeleted 删除状态
     * @return 奖品
     */
    Prize findByIdAndIsDeleted(Long id, Integer isDeleted);

    /**
     * 查找所有未删除的奖品（管理员用）
     *
     * @return 奖品列表
     */
    @Query("SELECT p FROM Prize p WHERE p.isDeleted = 0 ORDER BY p.sortOrder ASC, p.createTime DESC")
    List<Prize> findAllActive();

    /**
     * 根据名称查找奖品（用于重名检查）
     *
     * @param name 奖品名称
     * @return 奖品列表
     */
    @Query("SELECT p FROM Prize p WHERE p.name = :name AND p.isDeleted = 0")
    List<Prize> findByNameAndNotDeleted(@Param("name") String name);

}

package com.lureclub.points.repository;

import com.lureclub.points.entity.user.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * 用户数据访问接口
 *
 * @author system
 * @date 2025-06-19
 */
@Repository
public interface UserRepository extends JpaRepository<User, Long> {

    /**
     * 根据用户名查找用户
     *
     * @param username 用户名
     * @return 用户信息
     */
    User findByUsername(String username);

    /**
     * 根据手机号查找用户
     *
     * @param phone 手机号
     * @return 用户信息
     */
    User findByPhone(String phone);

    /**
     * 根据用户名或手机号查找用户
     *
     * @param username 用户名
     * @param phone 手机号
     * @return 用户信息
     */
    @Query("SELECT u FROM User u WHERE (u.username = :username OR u.phone = :phone) AND u.isDeleted = 0")
    User findByUsernameOrPhone(@Param("username") String username, @Param("phone") String phone);

    /**
     * 检查用户名是否存在
     *
     * @param username 用户名
     * @return 是否存在
     */
    boolean existsByUsername(String username);

    /**
     * 检查手机号是否存在
     *
     * @param phone 手机号
     * @return 是否存在
     */
    boolean existsByPhone(String phone);

    /**
     * 查找所有未删除的用户
     *
     * @return 用户列表
     */
    @Query("SELECT u FROM User u WHERE u.isDeleted = 0 ORDER BY u.createTime DESC")
    List<User> findAllActiveUsers();

    /**
     * 根据ID查找未删除的用户
     *
     * @param id 用户ID
     * @return 用户信息
     */
    @Query("SELECT u FROM User u WHERE u.id = :id AND u.isDeleted = 0")
    Optional<User> findActiveUserById(@Param("id") Long id);

    /**
     * 根据用户名模糊搜索
     *
     * @param username 用户名关键词
     * @return 用户列表
     */
    @Query("SELECT u FROM User u WHERE u.username LIKE %:username% AND u.isDeleted = 0")
    List<User> findByUsernameContaining(@Param("username") String username);

    /**
     * 根据手机号模糊搜索
     *
     * @param phone 手机号关键词
     * @return 用户列表
     */
    @Query("SELECT u FROM User u WHERE u.phone LIKE %:phone% AND u.isDeleted = 0")
    List<User> findByPhoneContaining(@Param("phone") String phone);

    /**
     * 根据用户名和手机号模糊搜索
     *
     * @param username 用户名关键词
     * @param phone 手机号关键词
     * @return 用户列表
     */
    @Query("SELECT u FROM User u WHERE u.username LIKE %:username% AND u.phone LIKE %:phone% AND u.isDeleted = 0")
    List<User> findByUsernameContainingAndPhoneContaining(@Param("username") String username, @Param("phone") String phone);

}

package com.lureclub.points.service.impl;

import com.lureclub.points.entity.admin.Admin;
import com.lureclub.points.entity.admin.vo.request.AdminLoginVo;
import com.lureclub.points.entity.admin.vo.request.AdminCreateVo;
import com.lureclub.points.entity.admin.vo.response.AdminVo;
import com.lureclub.points.entity.admin.vo.response.LoginVo;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.repository.AdminRepository;
import com.lureclub.points.service.AdminService;
import com.lureclub.points.util.JwtUtil;
import com.lureclub.points.util.PasswordUtil;
import com.lureclub.points.entity.admin.AdminConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

/**
 * 管理员服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class AdminServiceImpl implements AdminService {

    @Autowired
    private AdminRepository adminRepository;

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private PasswordUtil passwordUtil;

    @Autowired
    private AdminConverter adminConverter;

    /**
     * 管理员登录实现
     */
    @Override
    public LoginVo login(AdminLoginVo loginVo) {
        // 根据用户名查找管理员
        Admin admin = adminRepository.findByUsername(loginVo.getUsername());

        if (admin == null || admin.getIsDeleted() == 1) {
            throw new BusinessException("管理员不存在");
        }

        if (!admin.getIsEnabled()) {
            throw new BusinessException("管理员账号已被禁用");
        }

        // 验证密码
        if (!passwordUtil.matches(loginVo.getPassword(), admin.getPassword())) {
            throw new BusinessException("密码错误");
        }

        // 生成JWT token（管理员ID前加负号区分普通用户）
        String token = jwtUtil.generateToken(-admin.getId());

        // 构建管理员信息
        AdminVo adminVo = adminConverter.toAdminVo(admin);

        return new LoginVo(token, adminVo);
    }

    /**
     * 获取当前管理员信息实现
     */
    @Override
    public AdminVo getCurrentAdmin() {
        Long adminId = getCurrentAdminId();
        Admin admin = adminRepository.findById(adminId).orElse(null);

        if (admin == null || admin.getIsDeleted() == 1) {
            throw new BusinessException("管理员不存在");
        }

        return adminConverter.toAdminVo(admin);
    }

    /**
     * 创建管理员实现
     */
    @Override
    public AdminVo createAdmin(AdminCreateVo createVo) {
        // 检查用户名是否已存在
        if (adminRepository.existsByUsername(createVo.getUsername())) {
            throw new BusinessException("管理员用户名已存在");
        }

        // 创建新管理员
        Admin admin = new Admin();
        admin.setUsername(createVo.getUsername());
        admin.setPassword(passwordUtil.encode(createVo.getPassword()));
        admin.setRealName(createVo.getRealName());

        // 保存管理员
        admin = adminRepository.save(admin);

        return adminConverter.toAdminVo(admin);
    }

    /**
     * 管理员登出实现
     */
    @Override
    public void logout() {
        // 清除安全上下文
        SecurityContextHolder.clearContext();
    }

    /**
     * 根据用户名查找管理员实现
     */
    @Override
    public AdminVo findByUsername(String username) {
        Admin admin = adminRepository.findByUsername(username);
        if (admin == null || admin.getIsDeleted() == 1) {
            return null;
        }
        return adminConverter.toAdminVo(admin);
    }

    /**
     * 获取所有管理员实现
     */
    @Override
    public List<AdminVo> getAllAdmins() {
        List<Admin> admins = adminRepository.findAllActive();

        return admins.stream()
                .map(adminConverter::toAdminVo)
                .collect(Collectors.toList());
    }

    /**
     * 获取当前登录管理员ID
     */
    private Long getCurrentAdminId() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof Long) {
            Long id = (Long) principal;
            // 管理员ID是负数，转换为正数
            return id < 0 ? -id : id;
        }
        throw new BusinessException("管理员未登录");
    }

}

package com.lureclub.points.service.impl;

import com.lureclub.points.entity.user.User;
import com.lureclub.points.entity.user.vo.request.UserCreateVo;
import com.lureclub.points.entity.user.vo.request.UserUpdateVo;
import com.lureclub.points.entity.user.vo.request.UserSearchVo;
import com.lureclub.points.entity.user.vo.response.UserVo;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.repository.UserRepository;
import com.lureclub.points.service.AdminUserService;
import com.lureclub.points.service.PointsService;
import com.lureclub.points.util.PasswordUtil;
import com.lureclub.points.util.ValidationUtil;
import com.lureclub.points.entity.user.UserConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.List;
import java.util.stream.Collectors;

/**
 * 管理员用户管理服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class AdminUserServiceImpl implements AdminUserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordUtil passwordUtil;

    @Autowired
    private PointsService pointsService;

    @Autowired
    private UserConverter userConverter;

    @Autowired
    private ValidationUtil validationUtil;

    /**
     * 获取所有用户实现
     */
    @Override
    public List<UserVo> getAllUsers() {
        List<User> users = userRepository.findAllActiveUsers();
        return users.stream()
                .map(userConverter::toUserVo)
                .collect(Collectors.toList());
    }

    /**
     * 搜索用户实现
     */
    @Override
    public List<UserVo> searchUsers(UserSearchVo searchVo) {
        List<User> users;

        if (StringUtils.hasText(searchVo.getUsername()) && StringUtils.hasText(searchVo.getPhone())) {
            // 同时按用户名和手机号搜索
            users = userRepository.findByUsernameContainingAndPhoneContaining(
                    searchVo.getUsername(), searchVo.getPhone());
        } else if (StringUtils.hasText(searchVo.getUsername())) {
            // 按用户名搜索
            users = userRepository.findByUsernameContaining(searchVo.getUsername());
        } else if (StringUtils.hasText(searchVo.getPhone())) {
            // 按手机号搜索
            users = userRepository.findByPhoneContaining(searchVo.getPhone());
        } else {
            // 无搜索条件，返回所有用户
            users = userRepository.findAllActiveUsers();
        }

        return users.stream()
                .map(userConverter::toUserVo)
                .collect(Collectors.toList());
    }

    /**
     * 创建用户实现
     */
    @Override
    @Transactional
    public UserVo createUser(UserCreateVo createVo) {
        // 验证用户名格式
        if (!validationUtil.isValidUsername(createVo.getUsername())) {
            throw new BusinessException("用户名格式不正确");
        }

        // 验证密码强度
        if (!validationUtil.isValidPassword(createVo.getPassword())) {
            throw new BusinessException("密码长度必须在6-20个字符之间");
        }

        // 验证手机号格式
        if (!validationUtil.isValidPhone(createVo.getPhone())) {
            throw new BusinessException("手机号格式不正确");
        }

        // 检查用户名是否已存在
        if (userRepository.existsByUsername(createVo.getUsername())) {
            throw new BusinessException("用户名已存在");
        }

        // 检查手机号是否已存在
        if (userRepository.existsByPhone(createVo.getPhone())) {
            throw new BusinessException("手机号已存在");
        }

        // 创建新用户
        User user = new User();
        user.setUsername(createVo.getUsername());
        user.setPassword(passwordUtil.encode(createVo.getPassword()));
        user.setPhone(createVo.getPhone());

        // 保存用户
        user = userRepository.save(user);

        // 初始化用户积分
        pointsService.initUserPoints(user.getId());

        return userConverter.toUserVo(user);
    }

    /**
     * 更新用户信息实现
     */
    @Override
    @Transactional
    public UserVo updateUser(Long userId, UserUpdateVo updateVo) {
        User user = userRepository.findActiveUserById(userId).orElse(null);
        if (user == null) {
            throw new BusinessException("用户不存在");
        }

        // 更新用户名
        if (StringUtils.hasText(updateVo.getUsername()) && !updateVo.getUsername().equals(user.getUsername())) {
            if (!validationUtil.isValidUsername(updateVo.getUsername())) {
                throw new BusinessException("用户名格式不正确");
            }
            if (userRepository.existsByUsername(updateVo.getUsername())) {
                throw new BusinessException("用户名已存在");
            }
            user.setUsername(updateVo.getUsername());
        }

        // 更新密码
        if (StringUtils.hasText(updateVo.getPassword())) {
            if (!validationUtil.isValidPassword(updateVo.getPassword())) {
                throw new BusinessException("密码长度必须在6-20个字符之间");
            }
            user.setPassword(passwordUtil.encode(updateVo.getPassword()));
        }

        // 更新手机号
        if (StringUtils.hasText(updateVo.getPhone()) && !updateVo.getPhone().equals(user.getPhone())) {
            if (!validationUtil.isValidPhone(updateVo.getPhone())) {
                throw new BusinessException("手机号格式不正确");
            }
            if (userRepository.existsByPhone(updateVo.getPhone())) {
                throw new BusinessException("手机号已存在");
            }
            user.setPhone(updateVo.getPhone());
        }

        user = userRepository.save(user);
        return userConverter.toUserVo(user);
    }

    /**
     * 删除用户实现
     */
    @Override
    @Transactional
    public void deleteUser(Long userId) {
        User user = userRepository.findActiveUserById(userId).orElse(null);
        if (user == null) {
            throw new BusinessException("用户不存在");
        }

        // 软删除
        user.setIsDeleted(1);
        userRepository.save(user);
    }

    /**
     * 根据ID获取用户实现
     */
    @Override
    public UserVo getUserById(Long userId) {
        User user = userRepository.findActiveUserById(userId).orElse(null);
        if (user == null) {
            throw new BusinessException("用户不存在");
        }
        return userConverter.toUserVo(user);
    }

}


package com.lureclub.points.service.impl;

import com.lureclub.points.entity.announcement.Announcement;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementCreateVo;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementUpdateVo;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementSearchVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementListVo;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.repository.AnnouncementRepository;
import com.lureclub.points.service.AnnouncementService;
import com.lureclub.points.entity.announcement.AnnouncementConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.List;
import java.util.stream.Collectors;

/**
 * 公告服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class AnnouncementServiceImpl implements AnnouncementService {

    @Autowired
    private AnnouncementRepository announcementRepository;

    @Autowired
    private AnnouncementConverter announcementConverter;

    /**
     * 获取所有公告实现（用户端）
     */
    @Override
    public List<AnnouncementListVo> getAllAnnouncements() {
        List<Announcement> announcements = announcementRepository.findAllActiveOrderByTopAndDate();

        return announcements.stream()
                .map(announcementConverter::toAnnouncementListVo)
                .collect(Collectors.toList());
    }

    /**
     * 搜索公告实现（用户端）
     */
    @Override
    public List<AnnouncementListVo> searchAnnouncements(AnnouncementSearchVo searchVo) {
        List<Announcement> announcements;

        if (searchVo.getStartDate() != null || searchVo.getEndDate() != null) {
            // 按日期范围搜索
            announcements = announcementRepository.findByDateRange(
                    searchVo.getStartDate(),
                    searchVo.getEndDate()
            );
        } else if (StringUtils.hasText(searchVo.getKeyword())) {
            // 按关键词搜索
            announcements = announcementRepository.findByKeyword(searchVo.getKeyword());
        } else if (Boolean.TRUE.equals(searchVo.getOnlyTop())) {
            // 只显示置顶公告
            announcements = announcementRepository.findTopAnnouncements();
        } else {
            // 获取所有公告
            announcements = announcementRepository.findAllActiveOrderByTopAndDate();
        }

        return announcements.stream()
                .map(announcementConverter::toAnnouncementListVo)
                .collect(Collectors.toList());
    }

    /**
     * 获取公告详情实现
     */
    @Override
    public AnnouncementVo getAnnouncementDetail(Long id) {
        Announcement announcement = announcementRepository.findByIdAndIsDeleted(id, 0);

        if (announcement == null) {
            throw new BusinessException("公告不存在");
        }

        return announcementConverter.toAnnouncementVo(announcement);
    }

    /**
     * 创建公告实现（管理员）
     */
    @Override
    @Transactional
    public AnnouncementVo createAnnouncement(AnnouncementCreateVo createVo) {
        Announcement announcement = new Announcement();
        announcement.setTitle(createVo.getTitle());
        announcement.setContent(createVo.getContent());

        if (createVo.getPublishDate() != null) {
            announcement.setPublishDate(createVo.getPublishDate());
        }

        if (createVo.getIsTop() != null) {
            announcement.setIsTop(createVo.getIsTop());
        }

        announcement = announcementRepository.save(announcement);

        return announcementConverter.toAnnouncementVo(announcement);
    }

    /**
     * 更新公告实现（管理员）
     */
    @Override
    @Transactional
    public AnnouncementVo updateAnnouncement(Long id, AnnouncementUpdateVo updateVo) {
        Announcement announcement = announcementRepository.findByIdAndIsDeleted(id, 0);

        if (announcement == null) {
            throw new BusinessException("公告不存在");
        }

        if (StringUtils.hasText(updateVo.getTitle())) {
            announcement.setTitle(updateVo.getTitle());
        }

        if (StringUtils.hasText(updateVo.getContent())) {
            announcement.setContent(updateVo.getContent());
        }

        if (updateVo.getPublishDate() != null) {
            announcement.setPublishDate(updateVo.getPublishDate());
        }

        if (updateVo.getIsTop() != null) {
            announcement.setIsTop(updateVo.getIsTop());
        }

        announcement = announcementRepository.save(announcement);

        return announcementConverter.toAnnouncementVo(announcement);
    }

    /**
     * 删除公告实现（管理员）
     */
    @Override
    @Transactional
    public void deleteAnnouncement(Long id) {
        Announcement announcement = announcementRepository.findByIdAndIsDeleted(id, 0);

        if (announcement == null) {
            throw new BusinessException("公告不存在");
        }

        announcement.setIsDeleted(1);
        announcementRepository.save(announcement);
    }

    /**
     * 获取所有公告实现（管理员端）
     */
    @Override
    public List<AnnouncementVo> getAllAnnouncementsForAdmin() {
        List<Announcement> announcements = announcementRepository.findAllActive();

        return announcements.stream()
                .map(announcementConverter::toAnnouncementVo)
                .collect(Collectors.toList());
    }

}

package com.lureclub.points.service.impl;

import com.lureclub.points.entity.message.Message;
import com.lureclub.points.entity.message.MessageReply;
import com.lureclub.points.entity.message.vo.request.MessageCreateVo;
import com.lureclub.points.entity.message.vo.request.MessageReplyVo;
import com.lureclub.points.entity.message.vo.response.MessageVo;
import com.lureclub.points.entity.user.User;
import com.lureclub.points.enums.MessageStatus;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.repository.MessageRepository;
import com.lureclub.points.repository.MessageReplyRepository;
import com.lureclub.points.repository.UserRepository;
import com.lureclub.points.service.MessageService;
import com.lureclub.points.util.ValidationUtil;
import com.lureclub.points.entity.message.MessageConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * 留言服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class MessageServiceImpl implements MessageService {

    @Autowired
    private MessageRepository messageRepository;

    @Autowired
    private MessageReplyRepository messageReplyRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ValidationUtil validationUtil;

    @Autowired
    private MessageConverter messageConverter;

    /**
     * 获取所有公开留言实现（用户端）
     */
    @Override
    public List<MessageVo> getAllPublicMessages() {
        List<Message> messages = messageRepository.findPublicMessages();
        return convertToMessageVoList(messages, true);
    }

    /**
     * 创建留言实现（用户）
     */
    @Override
    @Transactional
    public MessageVo createMessage(MessageCreateVo createVo) {
        Long userId = getCurrentUserId();

        // 验证留言内容长度
        if (createVo.getContent() == null || createVo.getContent().trim().isEmpty()) {
            throw new BusinessException("留言内容不能为空");
        }

        if (createVo.getContent().length() > 1000) {
            throw new BusinessException("留言内容不能超过1000个字符");
        }

        Message message = new Message(userId, createVo.getContent().trim());
        message = messageRepository.save(message);

        User user = userRepository.findById(userId).orElse(null);
        String username = user != null ? user.getUsername() : "未知用户";

        return messageConverter.toMessageVo(message, username, null);
    }

    /**
     * 获取所有留言实现（管理员）
     */
    @Override
    public List<MessageVo> getAllMessagesForAdmin() {
        List<Message> messages = messageRepository.findAllActiveOrderByCreateTime();
        return convertToMessageVoList(messages, false);
    }

    /**
     * 回复留言实现（管理员）
     */
    @Override
    @Transactional
    public MessageVo replyMessage(Long messageId, MessageReplyVo replyVo) {
        Message message = messageRepository.findByIdAndIsDeleted(messageId, 0);
        if (message == null) {
            throw new BusinessException("留言不存在");
        }

        // 创建回复
        MessageReply reply = new MessageReply(messageId, replyVo.getContent(), replyVo.getIsVisible());
        messageReplyRepository.save(reply);

        // 更新留言状态
        message.setStatus(MessageStatus.REPLIED);
        messageRepository.save(message);

        return getMessageVo(message);
    }

    /**
     * 设置留言可见性实现（管理员）
     */
    @Override
    @Transactional
    public MessageVo setMessageVisibility(Long messageId, Boolean isVisible) {
        Message message = messageRepository.findByIdAndIsDeleted(messageId, 0);
        if (message == null) {
            throw new BusinessException("留言不存在");
        }

        // 根据可见性设置状态
        if (Boolean.TRUE.equals(isVisible)) {
            if (message.getStatus() == MessageStatus.PENDING) {
                message.setStatus(MessageStatus.PUBLISHED);
            }
        } else {
            message.setStatus(MessageStatus.HIDDEN);
        }

        messageRepository.save(message);

        return getMessageVo(message);
    }

    /**
     * 转换为MessageVo列表
     */
    private List<MessageVo> convertToMessageVoList(List<Message> messages, boolean onlyVisibleReplies) {
        if (messages.isEmpty()) {
            return List.of();
        }

        // 获取所有留言的回复
        List<Long> messageIds = messages.stream().map(Message::getId).collect(Collectors.toList());
        List<MessageReply> allReplies = onlyVisibleReplies
                ? messageReplyRepository.findVisibleRepliesByMessageIds(messageIds)
                : messageReplyRepository.findAllRepliesByMessageIds(messageIds);

        Map<Long, List<MessageReply>> repliesMap = allReplies.stream()
                .collect(Collectors.groupingBy(MessageReply::getMessageId));

        // 获取用户信息
        List<Long> userIds = messages.stream().map(Message::getUserId).distinct().collect(Collectors.toList());
        Map<Long, User> userMap = userRepository.findAllById(userIds).stream()
                .collect(Collectors.toMap(User::getId, user -> user));

        return messages.stream()
                .map(message -> {
                    User user = userMap.get(message.getUserId());
                    String username = user != null ? user.getUsername() : "未知用户";

                    List<com.lureclub.points.entity.message.vo.response.MessageReplyVo> replyVos = repliesMap.getOrDefault(message.getId(), List.of())
                            .stream()
                            .map(messageConverter::toMessageReplyVo)
                            .collect(Collectors.toList());

                    return messageConverter.toMessageVo(message, username, replyVos);
                })
                .collect(Collectors.toList());
    }

    /**
     * 获取单个MessageVo
     */
    private MessageVo getMessageVo(Message message) {
        User user = userRepository.findById(message.getUserId()).orElse(null);
        String username = user != null ? user.getUsername() : "未知用户";

        List<MessageReply> replies = messageReplyRepository.findAllByMessageIdAndIsDeleted(message.getId(), 0);
        List<com.lureclub.points.entity.message.vo.response.MessageReplyVo> replyVos = replies.stream()
                .map(messageConverter::toMessageReplyVo)
                .collect(Collectors.toList());

        return messageConverter.toMessageVo(message, username, replyVos);
    }

    /**
     * 获取当前登录用户ID
     */
    private Long getCurrentUserId() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof Long) {
            return (Long) principal;
        }
        throw new BusinessException("用户未登录");
    }

}

package com.lureclub.points.service.impl;

import com.lureclub.points.entity.points.Points;
import com.lureclub.points.entity.points.PointsHistory;
import com.lureclub.points.entity.points.vo.request.PointsAddVo;
import com.lureclub.points.entity.points.vo.request.PointsDeductVo;
import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;
import com.lureclub.points.entity.user.User;
import com.lureclub.points.enums.PointsType;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.exception.InsufficientPointsException;
import com.lureclub.points.exception.UserNotFoundException;
import com.lureclub.points.repository.PointsRepository;
import com.lureclub.points.repository.PointsHistoryRepository;
import com.lureclub.points.repository.UserRepository;
import com.lureclub.points.service.PointsService;
import com.lureclub.points.util.PointsCalculatorUtil;
import com.lureclub.points.util.ValidationUtil;
import com.lureclub.points.entity.points.PointsConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 积分服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class PointsServiceImpl implements PointsService {

    @Autowired
    private PointsRepository pointsRepository;

    @Autowired
    private PointsHistoryRepository pointsHistoryRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PointsCalculatorUtil pointsCalculatorUtil;

    @Autowired
    private PointsConverter pointsConverter;

    @Autowired
    private ValidationUtil validationUtil;

    /**
     * 获取用户积分信息实现
     */
    @Override
    public PointsVo getUserPoints(Long userId) {
        Long targetUserId = userId != null ? userId : getCurrentUserId();

        // 确保用户存在
        User user = userRepository.findActiveUserById(targetUserId).orElse(null);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }

        // 获取或初始化积分记录
        Points points = pointsRepository.findByUserId(targetUserId);
        if (points == null) {
            initUserPoints(targetUserId);
            points = pointsRepository.findByUserId(targetUserId);
        }

        // 处理日期变更（将前一日积分转为有效积分）
        processDateChange(points);

        // 计算有效积分和总积分
        Integer effectivePoints = calculateEffectivePoints(targetUserId);
        Integer totalPoints = calculateTotalPoints(targetUserId);

        return pointsConverter.toPointsVo(points, effectivePoints, totalPoints);
    }

    /**
     * 获取用户积分历史实现
     */
    @Override
    public List<PointsHistoryVo> getUserPointsHistory(Long userId) {
        Long targetUserId = userId != null ? userId : getCurrentUserId();

        // 确保用户存在
        User user = userRepository.findActiveUserById(targetUserId).orElse(null);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }

        List<PointsHistory> historyList = pointsHistoryRepository
                .findByUserIdOrderByOperationDateDescCreateTimeDesc(targetUserId);

        return historyList.stream()
                .map(pointsConverter::toPointsHistoryVo)
                .collect(Collectors.toList());
    }

    /**
     * 录入用户积分实现（管理员操作）
     */
    @Override
    @Transactional
    public PointsVo addUserPoints(PointsAddVo pointsAddVo) {
        // 验证积分数量
        if (!validationUtil.isValidPoints(pointsAddVo.getPoints())) {
            throw new BusinessException("积分数量必须在1-10000之间");
        }

        // 确保用户存在
        User user = userRepository.findActiveUserById(pointsAddVo.getUserId()).orElse(null);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }

        // 获取或初始化积分记录
        Points points = pointsRepository.findByUserId(pointsAddVo.getUserId());
        if (points == null) {
            initUserPoints(pointsAddVo.getUserId());
            points = pointsRepository.findByUserId(pointsAddVo.getUserId());
        }

        // 处理日期变更
        processDateChange(points);

        // 录入当日积分
        points.addTodayPoints(pointsAddVo.getPoints());
        pointsRepository.save(points);

        // 记录积分历史
        PointsHistory history = new PointsHistory(
                pointsAddVo.getUserId(),
                PointsType.EARNED,
                pointsAddVo.getPoints(),
                "管理员录入积分: " + (pointsAddVo.getRemark() != null ? pointsAddVo.getRemark() : "当日钓鱼获得积分")
        );
        pointsHistoryRepository.save(history);

        return getUserPoints(pointsAddVo.getUserId());
    }

    /**
     * 抵扣用户积分实现（管理员操作）
     */
    @Override
    @Transactional
    public PointsVo deductUserPoints(PointsDeductVo pointsDeductVo) {
        Long userId = pointsDeductVo.getUserId();
        Integer deductPoints = pointsDeductVo.getPoints();

        // 验证积分数量
        if (!validationUtil.isValidPoints(deductPoints)) {
            throw new BusinessException("积分数量必须在1-10000之间");
        }

        // 确保用户存在
        User user = userRepository.findActiveUserById(userId).orElse(null);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }

        // 获取积分记录
        Points points = pointsRepository.findByUserId(userId);
        if (points == null) {
            throw new BusinessException("用户积分记录不存在");
        }

        // 处理日期变更
        processDateChange(points);

        // 检查有效积分是否足够
        Integer effectivePoints = calculateEffectivePoints(userId);
        if (effectivePoints < deductPoints) {
            throw new InsufficientPointsException(
                    String.format("有效积分不足，当前有效积分: %d，需要抵扣: %d", effectivePoints, deductPoints)
            );
        }

        // 记录积分历史（抵扣记录）
        PointsHistory history = new PointsHistory(
                userId,
                PointsType.DEDUCTED,
                -deductPoints, // 负数表示抵扣
                "管理员抵扣积分: " + (pointsDeductVo.getRemark() != null ? pointsDeductVo.getRemark() : "门票抵扣")
        );
        pointsHistoryRepository.save(history);

        return getUserPoints(userId);
    }

    /**
     * 检查是否可抵扣指定积分实现
     */
    @Override
    public Boolean checkDeductPoints(Long userId, Integer points) {
        if (!validationUtil.isValidPoints(points)) {
            return false;
        }

        try {
            Integer effectivePoints = calculateEffectivePoints(userId);
            return effectivePoints >= points;
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * 获取用户有效积分实现
     */
    @Override
    public Integer getUserEffectivePoints(Long userId) {
        return calculateEffectivePoints(userId);
    }

    /**
     * 获取用户总积分实现
     */
    @Override
    public Integer getUserTotalPoints(Long userId) {
        return calculateTotalPoints(userId);
    }

    /**
     * 初始化用户积分记录实现
     */
    @Override
    @Transactional
    public void initUserPoints(Long userId) {
        Points existingPoints = pointsRepository.findByUserId(userId);
        if (existingPoints == null) {
            Points points = new Points(userId);
            pointsRepository.save(points);
        }
    }

    /**
     * 获取所有用户积分数据实现（管理员）
     */
    @Override
    public List<PointsVo> getAllUserPoints() {
        List<User> allUsers = userRepository.findAllActiveUsers();

        return allUsers.stream()
                .map(user -> {
                    // 获取或初始化积分记录
                    Points points = pointsRepository.findByUserId(user.getId());
                    if (points == null) {
                        initUserPoints(user.getId());
                        points = pointsRepository.findByUserId(user.getId());
                    }

                    // 处理日期变更
                    processDateChange(points);

                    // 计算有效积分和总积分
                    Integer effectivePoints = calculateEffectivePoints(user.getId());
                    Integer totalPoints = calculateTotalPoints(user.getId());

                    return pointsConverter.toPointsVo(points, effectivePoints, totalPoints);
                })
                .collect(Collectors.toList());
    }

    /**
     * 处理日期变更逻辑
     */
    private void processDateChange(Points points) {
        LocalDate today = LocalDate.now();

        // 如果最后更新日期不是今天，则处理日期变更
        if (points.getLastPointsDate() == null || !points.getLastPointsDate().equals(today)) {
            points.processDateChange();
            pointsRepository.save(points);
        }
    }

    /**
     * 计算用户有效积分
     * 有效积分 = 历史所有获得积分 - 历史所有抵扣积分 - 当日积分
     */
    private Integer calculateEffectivePoints(Long userId) {
        LocalDate today = LocalDate.now();

        // 获取所有历史积分记录（不包括今天）
        List<PointsHistory> histories = pointsHistoryRepository.findByUserIdAndDateRange(userId, null, today.minusDays(1));

        int effectivePoints = 0;
        for (PointsHistory history : histories) {
            if (history.getPointsType() == PointsType.EARNED) {
                effectivePoints += history.getPoints();
            } else if (history.getPointsType() == PointsType.DEDUCTED) {
                effectivePoints += history.getPoints(); // 这里已经是负数
            }
        }

        return Math.max(0, effectivePoints);
    }

    /**
     * 计算用户总积分
     * 总积分 = 历史所有获得积分的总和（不包括抵扣）
     */
    private Integer calculateTotalPoints(Long userId) {
        Integer totalPoints = pointsHistoryRepository.calculateTotalPoints(userId);
        return totalPoints != null ? totalPoints : 0;
    }

    /**
     * 获取当前登录用户ID
     */
    private Long getCurrentUserId() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof Long) {
            Long id = (Long) principal;
            // 如果是负数，说明是管理员，抛出异常
            if (id < 0) {
                throw new BusinessException("管理员无法查看个人积分");
            }
            return id;
        }
        throw new BusinessException("用户未登录");
    }

}


package com.lureclub.points.service.impl;

import com.lureclub.points.entity.prize.Prize;
import com.lureclub.points.entity.prize.vo.request.PrizeCreateVo;
import com.lureclub.points.entity.prize.vo.request.PrizeUpdateVo;
import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.prize.vo.response.PrizeListVo;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.repository.PrizeRepository;
import com.lureclub.points.service.PrizeService;
import com.lureclub.points.util.FileUploadUtil;
import com.lureclub.points.entity.prize.PrizeConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
import java.util.stream.Collectors;

/**
 * 奖品服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class PrizeServiceImpl implements PrizeService {

    @Autowired
    private PrizeRepository prizeRepository;

    @Autowired
    private FileUploadUtil fileUploadUtil;

    @Autowired
    private PrizeConverter prizeConverter;

    /**
     * 获取所有奖品实现（用户端）
     */
    @Override
    public List<PrizeListVo> getAllPrizes() {
        List<Prize> prizes = prizeRepository.findAllActiveOrderBySortOrder();

        return prizes.stream()
                .map(prizeConverter::toPrizeListVo)
                .collect(Collectors.toList());
    }

    /**
     * 获取奖品详情实现
     */
    @Override
    public PrizeVo getPrizeDetail(Long id) {
        Prize prize = prizeRepository.findByIdAndIsDeletedAndIsEnabled(id, 0, true);

        if (prize == null) {
            throw new BusinessException("奖品不存在或已下架");
        }

        return prizeConverter.toPrizeVo(prize);
    }

    /**
     * 创建奖品实现（管理员）
     */
    @Override
    @Transactional
    public PrizeVo createPrize(PrizeCreateVo createVo, MultipartFile imageFile) {
        Prize prize = new Prize();
        prize.setName(createVo.getName());
        prize.setDescription(createVo.getDescription());

        if (createVo.getSortOrder() != null) {
            prize.setSortOrder(createVo.getSortOrder());
        }

        // 处理图片上传
        if (imageFile != null && !imageFile.isEmpty()) {
            String imageUrl = fileUploadUtil.uploadPrizeImage(imageFile);
            prize.setImageUrl(imageUrl);
        }

        prize = prizeRepository.save(prize);

        return prizeConverter.toPrizeVo(prize);
    }

    /**
     * 更新奖品实现（管理员）
     */
    @Override
    @Transactional
    public PrizeVo updatePrize(Long id, PrizeUpdateVo updateVo, MultipartFile imageFile) {
        Prize prize = prizeRepository.findByIdAndIsDeleted(id, 0);

        if (prize == null) {
            throw new BusinessException("奖品不存在");
        }

        if (StringUtils.hasText(updateVo.getName())) {
            prize.setName(updateVo.getName());
        }

        if (StringUtils.hasText(updateVo.getDescription())) {
            prize.setDescription(updateVo.getDescription());
        }

        if (updateVo.getSortOrder() != null) {
            prize.setSortOrder(updateVo.getSortOrder());
        }

        if (updateVo.getIsEnabled() != null) {
            prize.setIsEnabled(updateVo.getIsEnabled());
        }

        // 处理图片上传
        if (imageFile != null && !imageFile.isEmpty()) {
            String imageUrl = fileUploadUtil.uploadPrizeImage(imageFile);
            prize.setImageUrl(imageUrl);
        }

        prize = prizeRepository.save(prize);

        return prizeConverter.toPrizeVo(prize);
    }

    /**
     * 删除奖品实现（管理员）
     */
    @Override
    @Transactional
    public void deletePrize(Long id) {
        Prize prize = prizeRepository.findByIdAndIsDeleted(id, 0);

        if (prize == null) {
            throw new BusinessException("奖品不存在");
        }

        prize.setIsDeleted(1);
        prizeRepository.save(prize);
    }

    /**
     * 获取所有奖品实现（管理员端）
     */
    @Override
    public List<PrizeVo> getAllPrizesForAdmin() {
        List<Prize> prizes = prizeRepository.findAllActive();

        return prizes.stream()
                .map(prizeConverter::toPrizeVo)
                .collect(Collectors.toList());
    }

}

package com.lureclub.points.service.impl;

import com.lureclub.points.entity.points.PointsHistory;
import com.lureclub.points.entity.ranking.vo.response.RankingItemVo;
import com.lureclub.points.entity.user.User;
import com.lureclub.points.enums.PointsType;
import com.lureclub.points.repository.PointsHistoryRepository;
import com.lureclub.points.repository.UserRepository;
import com.lureclub.points.service.RankingService;
import com.lureclub.points.util.ValidationUtil;
import com.lureclub.points.entity.user.UserConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.util.*;
import java.util.stream.Collectors;

/**
 * 排行榜服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class RankingServiceImpl implements RankingService {

    @Autowired
    private PointsHistoryRepository pointsHistoryRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ValidationUtil validationUtil;

    @Autowired
    private UserConverter userConverter;

    /**
     * 获取当日排行榜实现
     */
    @Override
    public List<RankingItemVo> getDailyRanking() {
        LocalDate today = LocalDate.now();

        // 获取当日所有积分历史
        List<PointsHistory> todayHistory = pointsHistoryRepository.findAllByDateRange(today, today);

        // 按用户分组并计算当日积分
        Map<Long, Integer> userDailyPoints = new HashMap<>();
        for (PointsHistory history : todayHistory) {
            if (history.getPointsType() == PointsType.EARNED) {
                userDailyPoints.merge(history.getUserId(), history.getPoints(), Integer::sum);
            }
        }

        return buildRankingList(userDailyPoints);
    }

    /**
     * 获取本周排行榜实现
     */
    @Override
    public List<RankingItemVo> getWeeklyRanking() {
        // 计算本周开始和结束日期
        LocalDate today = LocalDate.now();
        LocalDate weekStart = today.with(DayOfWeek.MONDAY);
        LocalDate weekEnd = today.with(DayOfWeek.SUNDAY);

        // 获取本周所有积分历史
        List<PointsHistory> weekHistory = pointsHistoryRepository.findAllByDateRange(weekStart, weekEnd);

        // 按用户分组并计算本周积分
        Map<Long, Integer> userWeeklyPoints = new HashMap<>();
        for (PointsHistory history : weekHistory) {
            if (history.getPointsType() == PointsType.EARNED) {
                userWeeklyPoints.merge(history.getUserId(), history.getPoints(), Integer::sum);
            }
        }

        return buildRankingList(userWeeklyPoints);
    }

    /**
     * 获取总排行榜实现
     */
    @Override
    public List<RankingItemVo> getTotalRanking() {
        // 获取所有用户的总积分
        List<User> allUsers = userRepository.findAllActiveUsers();
        Map<Long, Integer> userTotalPoints = new HashMap<>();

        for (User user : allUsers) {
            Integer totalPoints = pointsHistoryRepository.calculateTotalPoints(user.getId());
            if (totalPoints != null && totalPoints > 0) {
                userTotalPoints.put(user.getId(), totalPoints);
            }
        }

        return buildRankingList(userTotalPoints);
    }

    /**
     * 构建排行榜列表
     *
     * @param userPointsMap 用户积分映射
     * @return 排行榜列表
     */
    private List<RankingItemVo> buildRankingList(Map<Long, Integer> userPointsMap) {
        if (userPointsMap.isEmpty()) {
            return new ArrayList<>();
        }

        // 按积分降序排序
        List<Map.Entry<Long, Integer>> sortedEntries = userPointsMap.entrySet()
                .stream()
                .sorted(Map.Entry.<Long, Integer>comparingByValue().reversed())
                .collect(Collectors.toList());

        // 构建排行榜
        List<RankingItemVo> rankingList = new ArrayList<>();
        Map<Long, User> userMap = getUserMap(userPointsMap.keySet());

        for (int i = 0; i < sortedEntries.size(); i++) {
            Map.Entry<Long, Integer> entry = sortedEntries.get(i);
            Long userId = entry.getKey();
            Integer points = entry.getValue();

            User user = userMap.get(userId);
            if (user != null) {
                // 使用ValidationUtil脱敏手机号显示在排行榜中
                String maskedPhone = validationUtil.maskPhone(user.getPhone());
                RankingItemVo rankingItem = new RankingItemVo(
                        i + 1, // 排名从1开始
                        userId,
                        user.getUsername(),
                        points
                );
                rankingList.add(rankingItem);
            }
        }

        return rankingList;
    }

    /**
     * 获取用户信息映射
     *
     * @param userIds 用户ID集合
     * @return 用户信息映射
     */
    private Map<Long, User> getUserMap(Set<Long> userIds) {
        List<User> users = userRepository.findAllById(userIds);
        return users.stream()
                .filter(user -> user.getIsDeleted() == 0)
                .collect(Collectors.toMap(User::getId, user -> user));
    }

}

package com.lureclub.points.service.impl;

import com.lureclub.points.entity.user.User;
import com.lureclub.points.entity.user.vo.request.UserLoginVo;
import com.lureclub.points.entity.user.vo.request.UserRegisterVo;
import com.lureclub.points.entity.user.vo.response.LoginVo;
import com.lureclub.points.entity.user.vo.response.UserVo;
import com.lureclub.points.exception.BusinessException;
import com.lureclub.points.repository.UserRepository;
import com.lureclub.points.service.UserService;
import com.lureclub.points.util.JwtUtil;
import com.lureclub.points.util.PasswordUtil;
import com.lureclub.points.util.ValidationUtil;
import com.lureclub.points.entity.user.UserConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;

/**
 * 用户服务实现类
 *
 * @author system
 * @date 2025-06-19
 */
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private PasswordUtil passwordUtil;

    @Autowired
    private UserConverter userConverter;

    @Autowired
    private ValidationUtil validationUtil;

    /**
     * 用户登录实现
     */
    @Override
    public LoginVo login(UserLoginVo loginVo) {
        // 根据用户名或手机号查找用户
        User user = userRepository.findByUsernameOrPhone(loginVo.getUsername(), loginVo.getUsername());

        if (user == null || user.getIsDeleted() == 1) {
            throw new BusinessException("用户不存在");
        }

        // 验证密码
        if (!passwordUtil.matches(loginVo.getPassword(), user.getPassword())) {
            throw new BusinessException("密码错误");
        }

        // 生成JWT token
        String token = jwtUtil.generateToken(user.getId());

        // 构建用户信息
        UserVo userVo = userConverter.toUserVo(user);

        return new LoginVo(token, userVo);
    }

    /**
     * 用户注册实现
     */
    @Override
    public UserVo register(UserRegisterVo registerVo) {
        // 验证确认密码
        if (!registerVo.getPassword().equals(registerVo.getConfirmPassword())) {
            throw new BusinessException("两次输入的密码不一致");
        }

        // 验证用户名格式
        if (!validationUtil.isValidUsername(registerVo.getUsername())) {
            throw new BusinessException("用户名格式不正确");
        }

        // 验证密码强度
        if (!validationUtil.isValidPassword(registerVo.getPassword())) {
            throw new BusinessException("密码长度必须在6-20个字符之间");
        }

        // 验证手机号格式
        if (!validationUtil.isValidPhone(registerVo.getPhone())) {
            throw new BusinessException("手机号格式不正确");
        }

        // 检查用户名是否已存在
        if (userRepository.existsByUsername(registerVo.getUsername())) {
            throw new BusinessException("用户名已存在");
        }

        // 检查手机号是否已存在
        if (userRepository.existsByPhone(registerVo.getPhone())) {
            throw new BusinessException("手机号已存在");
        }

        // 创建新用户
        User user = new User();
        user.setUsername(registerVo.getUsername());
        user.setPassword(passwordUtil.encode(registerVo.getPassword()));
        user.setPhone(registerVo.getPhone());

        // 保存用户
        user = userRepository.save(user);

        return userConverter.toUserVo(user);
    }

    /**
     * 获取当前用户信息实现
     */
    @Override
    public UserVo getCurrentUser() {
        Long userId = getCurrentUserId();
        User user = userRepository.findById(userId).orElse(null);

        if (user == null || user.getIsDeleted() == 1) {
            throw new BusinessException("用户不存在");
        }

        return userConverter.toUserVo(user);
    }

    /**
     * 用户登出实现
     */
    @Override
    public void logout() {
        // 清除安全上下文
        SecurityContextHolder.clearContext();
    }

    /**
     * 根据用户名或手机号查找用户
     */
    @Override
    public UserVo findByUsernameOrPhone(String username) {
        User user = userRepository.findByUsernameOrPhone(username, username);
        if (user == null || user.getIsDeleted() == 1) {
            return null;
        }
        return userConverter.toUserVo(user);
    }

    /**
     * 根据用户ID查找用户
     */
    @Override
    public UserVo findById(Long userId) {
        User user = userRepository.findById(userId).orElse(null);
        if (user == null || user.getIsDeleted() == 1) {
            return null;
        }
        return userConverter.toUserVo(user);
    }

    /**
     * 获取当前登录用户ID
     */
    private Long getCurrentUserId() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof Long) {
            return (Long) principal;
        }
        throw new BusinessException("用户未登录");
    }

}

package com.lureclub.points.service;

import com.lureclub.points.entity.admin.vo.request.AdminLoginVo;
import com.lureclub.points.entity.admin.vo.request.AdminCreateVo;
import com.lureclub.points.entity.admin.vo.response.AdminVo;
import com.lureclub.points.entity.admin.vo.response.LoginVo;

import java.util.List;

/**
 * 管理员服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface AdminService {

    /**
     * 管理员登录
     *
     * @param loginVo 登录信息
     * @return 登录结果
     */
    LoginVo login(AdminLoginVo loginVo);

    /**
     * 获取当前管理员信息
     *
     * @return 当前管理员信息
     */
    AdminVo getCurrentAdmin();

    /**
     * 创建管理员
     *
     * @param createVo 管理员信息
     * @return 管理员信息
     */
    AdminVo createAdmin(AdminCreateVo createVo);

    /**
     * 管理员登出
     */
    void logout();

    /**
     * 根据用户名查找管理员
     *
     * @param username 用户名
     * @return 管理员信息
     */
    AdminVo findByUsername(String username);

    /**
     * 获取所有管理员
     *
     * @return 管理员列表
     */
    List<AdminVo> getAllAdmins();

}

package com.lureclub.points.service;

import com.lureclub.points.entity.user.vo.request.UserCreateVo;
import com.lureclub.points.entity.user.vo.request.UserUpdateVo;
import com.lureclub.points.entity.user.vo.request.UserSearchVo;
import com.lureclub.points.entity.user.vo.response.UserVo;

import java.util.List;

/**
 * 管理员用户管理服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface AdminUserService {

    /**
     * 获取所有用户
     *
     * @return 用户列表
     */
    List<UserVo> getAllUsers();

    /**
     * 搜索用户
     *
     * @param searchVo 搜索条件
     * @return 用户列表
     */
    List<UserVo> searchUsers(UserSearchVo searchVo);

    /**
     * 创建用户
     *
     * @param createVo 用户信息
     * @return 用户信息
     */
    UserVo createUser(UserCreateVo createVo);

    /**
     * 更新用户信息
     *
     * @param userId 用户ID
     * @param updateVo 更新信息
     * @return 用户信息
     */
    UserVo updateUser(Long userId, UserUpdateVo updateVo);

    /**
     * 删除用户
     *
     * @param userId 用户ID
     */
    void deleteUser(Long userId);

    /**
     * 根据ID获取用户
     *
     * @param userId 用户ID
     * @return 用户信息
     */
    UserVo getUserById(Long userId);

}

package com.lureclub.points.service;

import com.lureclub.points.entity.announcement.vo.request.AnnouncementCreateVo;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementUpdateVo;
import com.lureclub.points.entity.announcement.vo.request.AnnouncementSearchVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementVo;
import com.lureclub.points.entity.announcement.vo.response.AnnouncementListVo;

import java.util.List;

/**
 * 公告服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface AnnouncementService {

    /**
     * 获取所有公告（用户端）
     *
     * @return 公告列表
     */
    List<AnnouncementListVo> getAllAnnouncements();

    /**
     * 搜索公告（用户端）
     *
     * @param searchVo 搜索条件
     * @return 公告列表
     */
    List<AnnouncementListVo> searchAnnouncements(AnnouncementSearchVo searchVo);

    /**
     * 获取公告详情
     *
     * @param id 公告ID
     * @return 公告详情
     */
    AnnouncementVo getAnnouncementDetail(Long id);

    /**
     * 创建公告（管理员）
     *
     * @param createVo 创建信息
     * @return 公告信息
     */
    AnnouncementVo createAnnouncement(AnnouncementCreateVo createVo);

    /**
     * 更新公告（管理员）
     *
     * @param id 公告ID
     * @param updateVo 更新信息
     * @return 公告信息
     */
    AnnouncementVo updateAnnouncement(Long id, AnnouncementUpdateVo updateVo);

    /**
     * 删除公告（管理员）
     *
     * @param id 公告ID
     */
    void deleteAnnouncement(Long id);

    /**
     * 获取所有公告（管理员端）
     *
     * @return 公告列表
     */
    List<AnnouncementVo> getAllAnnouncementsForAdmin();

}

package com.lureclub.points.service;

import com.lureclub.points.entity.message.vo.request.MessageCreateVo;
import com.lureclub.points.entity.message.vo.request.MessageReplyVo;
import com.lureclub.points.entity.message.vo.response.MessageVo;

import java.util.List;

/**
 * 留言服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface MessageService {

    /**
     * 获取所有公开留言（用户端）
     *
     * @return 留言列表
     */
    List<MessageVo> getAllPublicMessages();

    /**
     * 创建留言（用户）
     *
     * @param createVo 留言内容
     * @return 留言信息
     */
    MessageVo createMessage(MessageCreateVo createVo);

    /**
     * 获取所有留言（管理员）
     *
     * @return 留言列表
     */
    List<MessageVo> getAllMessagesForAdmin();

    /**
     * 回复留言（管理员）
     *
     * @param messageId 留言ID
     * @param replyVo 回复内容
     * @return 留言信息
     */
    MessageVo replyMessage(Long messageId, MessageReplyVo replyVo);

    /**
     * 设置留言可见性（管理员）
     *
     * @param messageId 留言ID
     * @param isVisible 是否可见
     * @return 留言信息
     */
    MessageVo setMessageVisibility(Long messageId, Boolean isVisible);

}

package com.lureclub.points.service;

import com.lureclub.points.entity.points.vo.request.PointsAddVo;
import com.lureclub.points.entity.points.vo.request.PointsDeductVo;
import com.lureclub.points.entity.points.vo.response.PointsVo;
import com.lureclub.points.entity.points.vo.response.PointsHistoryVo;

import java.util.List;

/**
 * 积分服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface PointsService {

    /**
     * 获取用户积分信息
     *
     * @param userId 用户ID（为null时获取当前用户）
     * @return 积分信息
     */
    PointsVo getUserPoints(Long userId);

    /**
     * 获取用户积分历史
     *
     * @param userId 用户ID（为null时获取当前用户）
     * @return 积分历史列表
     */
    List<PointsHistoryVo> getUserPointsHistory(Long userId);

    /**
     * 录入用户积分（管理员操作）
     *
     * @param pointsAddVo 积分录入信息
     * @return 操作结果
     */
    PointsVo addUserPoints(PointsAddVo pointsAddVo);

    /**
     * 抵扣用户积分（管理员操作）
     *
     * @param pointsDeductVo 积分抵扣信息
     * @return 操作结果
     */
    PointsVo deductUserPoints(PointsDeductVo pointsDeductVo);

    /**
     * 检查是否可抵扣指定积分
     *
     * @param userId 用户ID
     * @param points 要抵扣的积分数量
     * @return 是否可抵扣
     */
    Boolean checkDeductPoints(Long userId, Integer points);

    /**
     * 获取用户有效积分
     *
     * @param userId 用户ID
     * @return 有效积分数量
     */
    Integer getUserEffectivePoints(Long userId);

    /**
     * 获取用户总积分
     *
     * @param userId 用户ID
     * @return 总积分数量
     */
    Integer getUserTotalPoints(Long userId);

    /**
     * 初始化用户积分记录
     *
     * @param userId 用户ID
     */
    void initUserPoints(Long userId);

    /**
     * 获取所有用户积分数据（管理员）
     *
     * @return 所有用户积分列表
     */
    List<PointsVo> getAllUserPoints();

}

package com.lureclub.points.service;

import com.lureclub.points.entity.prize.vo.request.PrizeCreateVo;
import com.lureclub.points.entity.prize.vo.request.PrizeUpdateVo;
import com.lureclub.points.entity.prize.vo.response.PrizeVo;
import com.lureclub.points.entity.prize.vo.response.PrizeListVo;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

/**
 * 奖品服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface PrizeService {

    /**
     * 获取所有奖品（用户端）
     *
     * @return 奖品列表
     */
    List<PrizeListVo> getAllPrizes();

    /**
     * 获取奖品详情
     *
     * @param id 奖品ID
     * @return 奖品详情
     */
    PrizeVo getPrizeDetail(Long id);

    /**
     * 创建奖品（管理员）
     *
     * @param createVo 创建信息
     * @param imageFile 图片文件
     * @return 奖品信息
     */
    PrizeVo createPrize(PrizeCreateVo createVo, MultipartFile imageFile);

    /**
     * 更新奖品（管理员）
     *
     * @param id 奖品ID
     * @param updateVo 更新信息
     * @param imageFile 图片文件（可选）
     * @return 奖品信息
     */
    PrizeVo updatePrize(Long id, PrizeUpdateVo updateVo, MultipartFile imageFile);

    /**
     * 删除奖品（管理员）
     *
     * @param id 奖品ID
     */
    void deletePrize(Long id);

    /**
     * 获取所有奖品（管理员端）
     *
     * @return 奖品列表
     */
    List<PrizeVo> getAllPrizesForAdmin();

}

package com.lureclub.points.service;

import com.lureclub.points.entity.ranking.vo.response.RankingItemVo;

import java.util.List;

/**
 * 排行榜服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface RankingService {

    /**
     * 获取当日排行榜
     *
     * @return 当日排行榜列表
     */
    List<RankingItemVo> getDailyRanking();

    /**
     * 获取本周排行榜
     *
     * @return 本周排行榜列表
     */
    List<RankingItemVo> getWeeklyRanking();

    /**
     * 获取总排行榜
     *
     * @return 总排行榜列表
     */
    List<RankingItemVo> getTotalRanking();

}

package com.lureclub.points.service;

import com.lureclub.points.entity.user.vo.request.UserLoginVo;
import com.lureclub.points.entity.user.vo.request.UserRegisterVo;
import com.lureclub.points.entity.user.vo.response.LoginVo;
import com.lureclub.points.entity.user.vo.response.UserVo;

/**
 * 用户服务接口
 *
 * @author system
 * @date 2025-06-19
 */
public interface UserService {

    /**
     * 用户登录
     *
     * @param loginVo 登录信息
     * @return 登录结果
     */
    LoginVo login(UserLoginVo loginVo);

    /**
     * 用户注册
     *
     * @param registerVo 注册信息
     * @return 用户信息
     */
    UserVo register(UserRegisterVo registerVo);

    /**
     * 获取当前用户信息
     *
     * @return 当前用户信息
     */
    UserVo getCurrentUser();

    /**
     * 用户登出
     */
    void logout();

    /**
     * 根据用户名或手机号查找用户
     *
     * @param username 用户名或手机号
     * @return 用户信息
     */
    UserVo findByUsernameOrPhone(String username);

    /**
     * 根据用户ID查找用户
     *
     * @param userId 用户ID
     * @return 用户信息
     */
    UserVo findById(Long userId);

}

package com.lureclub.points.task;

import com.lureclub.points.entity.points.Points;
import com.lureclub.points.repository.PointsRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDate;
import java.util.List;

/**
 * 积分转换定时任务
 * 每日自动将所有用户的当日积分转为有效积分
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class PointsConversionTask {

    private static final Logger logger = LoggerFactory.getLogger(PointsConversionTask.class);

    @Autowired
    private PointsRepository pointsRepository;

    /**
     * 每天凌晨1点执行积分转换任务
     * 将前一日的当日积分转为有效积分
     */
    @Scheduled(cron = "0 0 1 * * ?")
    public void convertDailyPoints() {
        logger.info("开始执行积分转换定时任务");

        try {
            LocalDate today = LocalDate.now();

            // 查找需要处理日期变更的积分记录
            List<Points> pointsList = pointsRepository.findPointsNeedDateProcessing(today);

            int processedCount = 0;
            for (Points points : pointsList) {
                try {
                    // 处理日期变更，将当日积分转为有效积分
                    points.processDateChange();
                    pointsRepository.save(points);
                    processedCount++;
                } catch (Exception e) {
                    logger.error("处理用户{}的积分转换失败: {}", points.getUserId(), e.getMessage(), e);
                }
            }

            logger.info("积分转换定时任务执行完成，共处理{}条记录", processedCount);

        } catch (Exception e) {
            logger.error("积分转换定时任务执行失败: {}", e.getMessage(), e);
        }
    }

}
package com.lureclub.points.util;

import org.springframework.stereotype.Component;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.temporal.TemporalAdjusters;

/**
 * 日期工具类
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class DateUtil {

    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    private static final DateTimeFormatter DATETIME_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    /**
     * 获取当前日期
     *
     * @return 当前日期
     */
    public LocalDate getCurrentDate() {
        return LocalDate.now();
    }

    /**
     * 获取当前日期时间
     *
     * @return 当前日期时间
     */
    public LocalDateTime getCurrentDateTime() {
        return LocalDateTime.now();
    }

    /**
     * 获取本周开始日期（周一）
     *
     * @return 本周开始日期
     */
    public LocalDate getWeekStart() {
        return LocalDate.now().with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY));
    }

    /**
     * 获取本周结束日期（周日）
     *
     * @return 本周结束日期
     */
    public LocalDate getWeekEnd() {
        return LocalDate.now().with(TemporalAdjusters.nextOrSame(DayOfWeek.SUNDAY));
    }

    /**
     * 获取本月开始日期
     *
     * @return 本月开始日期
     */
    public LocalDate getMonthStart() {
        return LocalDate.now().with(TemporalAdjusters.firstDayOfMonth());
    }

    /**
     * 获取本月结束日期
     *
     * @return 本月结束日期
     */
    public LocalDate getMonthEnd() {
        return LocalDate.now().with(TemporalAdjusters.lastDayOfMonth());
    }

    /**
     * 格式化日期
     *
     * @param date 日期
     * @return 格式化后的日期字符串
     */
    public String formatDate(LocalDate date) {
        return date != null ? date.format(DATE_FORMATTER) : null;
    }

    /**
     * 格式化日期时间
     *
     * @param dateTime 日期时间
     * @return 格式化后的日期时间字符串
     */
    public String formatDateTime(LocalDateTime dateTime) {
        return dateTime != null ? dateTime.format(DATETIME_FORMATTER) : null;
    }

    /**
     * 解析日期字符串
     *
     * @param dateStr 日期字符串
     * @return 日期
     */
    public LocalDate parseDate(String dateStr) {
        try {
            return LocalDate.parse(dateStr, DATE_FORMATTER);
        } catch (Exception e) {
            return null;
        }
    }

    /**
     * 检查是否是今天
     *
     * @param date 日期
     * @return 是否是今天
     */
    public boolean isToday(LocalDate date) {
        return date != null && date.equals(LocalDate.now());
    }

    /**
     * 检查是否是本周
     *
     * @param date 日期
     * @return 是否是本周
     */
    public boolean isThisWeek(LocalDate date) {
        if (date == null) {
            return false;
        }
        LocalDate weekStart = getWeekStart();
        LocalDate weekEnd = getWeekEnd();
        return !date.isBefore(weekStart) && !date.isAfter(weekEnd);
    }

    /**
     * 计算两个日期之间的天数差
     *
     * @param startDate 开始日期
     * @param endDate 结束日期
     * @return 天数差
     */
    public long daysBetween(LocalDate startDate, LocalDate endDate) {
        if (startDate == null || endDate == null) {
            return 0;
        }
        return java.time.temporal.ChronoUnit.DAYS.between(startDate, endDate);
    }

}


package com.lureclub.points.util;

import com.lureclub.points.exception.BusinessException;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.List;
import java.util.UUID;

/**
 * 文件上传工具类
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class FileUploadUtil {

    @Value("${file.upload.path}")
    private String uploadPath;

    @Value("${file.upload.prize-images}")
    private String prizeImagesPath;

    // 允许的图片格式
    private static final List<String> ALLOWED_IMAGE_TYPES = Arrays.asList(
            "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp"
    );

    // 最大文件大小 (10MB)
    private static final long MAX_FILE_SIZE = 10 * 1024 * 1024;

    /**
     * 上传奖品图片
     *
     * @param file 图片文件
     * @return 图片URL
     */
    public String uploadPrizeImage(MultipartFile file) {
        // 验证文件
        validateImageFile(file);

        // 创建目录
        String fullPath = uploadPath + prizeImagesPath;
        createDirectoryIfNotExists(fullPath);

        // 生成文件名
        String fileName = generateFileName(file.getOriginalFilename());

        // 保存文件
        try {
            Path filePath = Paths.get(fullPath, fileName);
            Files.copy(file.getInputStream(), filePath);

            // 返回访问URL
            return prizeImagesPath + fileName;

        } catch (IOException e) {
            throw new BusinessException("文件上传失败: " + e.getMessage());
        }
    }

    /**
     * 验证图片文件
     *
     * @param file 文件
     */
    private void validateImageFile(MultipartFile file) {
        if (file == null || file.isEmpty()) {
            throw new BusinessException("文件不能为空");
        }

        // 检查文件大小
        if (file.getSize() > MAX_FILE_SIZE) {
            throw new BusinessException("文件大小不能超过10MB");
        }

        // 检查文件类型
        String contentType = file.getContentType();
        if (contentType == null || !ALLOWED_IMAGE_TYPES.contains(contentType.toLowerCase())) {
            throw new BusinessException("只支持jpg、png、gif、webp格式的图片");
        }

        // 检查文件扩展名
        String originalFilename = file.getOriginalFilename();
        if (originalFilename == null || !hasValidImageExtension(originalFilename)) {
            throw new BusinessException("文件扩展名不正确");
        }
    }

    /**
     * 检查文件扩展名
     *
     * @param filename 文件名
     * @return 是否有效
     */
    private boolean hasValidImageExtension(String filename) {
        String extension = getFileExtension(filename).toLowerCase();
        return Arrays.asList("jpg", "jpeg", "png", "gif", "webp").contains(extension);
    }

    /**
     * 获取文件扩展名
     *
     * @param filename 文件名
     * @return 扩展名
     */
    private String getFileExtension(String filename) {
        if (filename == null || !filename.contains(".")) {
            return "";
        }
        return filename.substring(filename.lastIndexOf(".") + 1);
    }

    /**
     * 生成唯一文件名
     *
     * @param originalFilename 原始文件名
     * @return 新文件名
     */
    private String generateFileName(String originalFilename) {
        String extension = getFileExtension(originalFilename);
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        String uuid = UUID.randomUUID().toString().replace("-", "");
        return timestamp + "_" + uuid + "." + extension;
    }

    /**
     * 创建目录（如果不存在）
     *
     * @param path 目录路径
     */
    private void createDirectoryIfNotExists(String path) {
        File directory = new File(path);
        if (!directory.exists()) {
            boolean created = directory.mkdirs();
            if (!created) {
                throw new BusinessException("创建上传目录失败: " + path);
            }
        }
    }

    /**
     * 删除文件
     *
     * @param fileUrl 文件URL
     * @return 是否删除成功
     */
    public boolean deleteFile(String fileUrl) {
        if (fileUrl == null || fileUrl.isEmpty()) {
            return true;
        }

        try {
            String fullPath = uploadPath + fileUrl;
            Path filePath = Paths.get(fullPath);
            return Files.deleteIfExists(filePath);
        } catch (IOException e) {
            return false;
        }
    }

}

package com.lureclub.points.util;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.util.Date;

/**
 * JWT工具类
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class JwtUtil {

    @Value("${jwt.secret}")
    private String secret;

    @Value("${jwt.expiration}")
    private Long expiration;

    /**
     * 生成JWT密钥
     */
    private SecretKey getSigningKey() {
        return Keys.hmacShaKeyFor(secret.getBytes());
    }

    /**
     * 生成JWT token
     *
     * @param userId 用户ID（管理员ID应为负数）
     * @return JWT token
     */
    public String generateToken(Long userId) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expiration);

        return Jwts.builder()
                .setSubject(userId.toString())
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .signWith(getSigningKey())
                .compact();
    }

    /**
     * 从token中获取用户ID
     *
     * @param token JWT token
     * @return 用户ID（管理员ID为负数）
     */
    public Long getUserIdFromToken(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();

        return Long.parseLong(claims.getSubject());
    }

    /**
     * 验证token是否有效
     *
     * @param token JWT token
     * @return 是否有效
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                    .setSigningKey(getSigningKey())
                    .build()
                    .parseClaimsJws(token);
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            return false;
        }
    }

    /**
     * 检查token是否过期
     *
     * @param token JWT token
     * @return 是否过期
     */
    public boolean isTokenExpired(String token) {
        try {
            Claims claims = Jwts.parserBuilder()
                    .setSigningKey(getSigningKey())
                    .build()
                    .parseClaimsJws(token)
                    .getBody();

            return claims.getExpiration().before(new Date());
        } catch (JwtException | IllegalArgumentException e) {
            return true;
        }
    }

    /**
     * 获取token剩余有效时间(毫秒)
     *
     * @param token JWT token
     * @return 剩余有效时间
     */
    public Long getTokenRemainingTime(String token) {
        try {
            Claims claims = Jwts.parserBuilder()
                    .setSigningKey(getSigningKey())
                    .build()
                    .parseClaimsJws(token)
                    .getBody();

            Date expiration = claims.getExpiration();
            Date now = new Date();

            if (expiration.before(now)) {
                return 0L;
            }

            return expiration.getTime() - now.getTime();
        } catch (JwtException | IllegalArgumentException e) {
            return 0L;
        }
    }

}

package com.lureclub.points.util;

import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Component;

/**
 * 密码工具类
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class PasswordUtil {

    private final BCryptPasswordEncoder passwordEncoder;

    public PasswordUtil() {
        this.passwordEncoder = new BCryptPasswordEncoder();
    }

    /**
     * 加密密码
     *
     * @param rawPassword 原始密码
     * @return 加密后的密码
     */
    public String encode(String rawPassword) {
        return passwordEncoder.encode(rawPassword);
    }

    /**
     * 验证密码
     *
     * @param rawPassword 原始密码
     * @param encodedPassword 加密后的密码
     * @return 是否匹配
     */
    public boolean matches(String rawPassword, String encodedPassword) {
        return passwordEncoder.matches(rawPassword, encodedPassword);
    }

}

package com.lureclub.points.util;

import com.lureclub.points.repository.PointsHistoryRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDate;

/**
 * 积分计算工具类
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class PointsCalculatorUtil {

    @Autowired
    private PointsHistoryRepository pointsHistoryRepository;

    /**
     * 计算用户有效积分
     * 有效积分 = 历史获得积分 - 历史抵扣积分（不包括当日积分）
     *
     * @param userId 用户ID
     * @return 有效积分数量
     */
    public Integer calculateEffectivePoints(Long userId) {
        if (userId == null) {
            return 0;
        }

        LocalDate today = LocalDate.now();
        Integer effectivePoints = pointsHistoryRepository.calculateEffectivePoints(userId, today);
        return effectivePoints != null ? effectivePoints : 0;
    }

    /**
     * 计算用户总积分
     * 总积分 = 所有获得积分的总和
     *
     * @param userId 用户ID
     * @return 总积分数量
     */
    public Integer calculateTotalPoints(Long userId) {
        if (userId == null) {
            return 0;
        }

        Integer totalPoints = pointsHistoryRepository.calculateTotalPoints(userId);
        return totalPoints != null ? totalPoints : 0;
    }

    /**
     * 验证积分数量是否有效
     *
     * @param points 积分数量
     * @return 是否有效
     */
    public boolean isValidPoints(Integer points) {
        return points != null && points > 0;
    }

    /**
     * 验证抵扣积分是否有效
     *
     * @param points 抵扣积分数量
     * @param effectivePoints 当前有效积分
     * @return 是否可以抵扣
     */
    public boolean canDeduct(Integer points, Integer effectivePoints) {
        return isValidPoints(points) &&
                effectivePoints != null &&
                effectivePoints >= points;
    }

}

package com.lureclub.points.util;

import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.util.regex.Pattern;

/**
 * 验证工具类
 *
 * @author system
 * @date 2025-06-19
 */
@Component
public class ValidationUtil {

    private static final Pattern PHONE_PATTERN = Pattern.compile("^1[3-9]\\d{9}$");
    private static final Pattern USERNAME_PATTERN = Pattern.compile("^[a-zA-Z0-9_\\u4e00-\\u9fa5]{3,20}$");

    /**
     * 验证手机号格式
     *
     * @param phone 手机号
     * @return 是否有效
     */
    public boolean isValidPhone(String phone) {
        return StringUtils.hasText(phone) && PHONE_PATTERN.matcher(phone).matches();
    }

    /**
     * 验证用户名格式
     *
     * @param username 用户名
     * @return 是否有效
     */
    public boolean isValidUsername(String username) {
        return StringUtils.hasText(username) && USERNAME_PATTERN.matcher(username).matches();
    }

    /**
     * 验证密码强度
     *
     * @param password 密码
     * @return 是否有效
     */
    public boolean isValidPassword(String password) {
        return StringUtils.hasText(password) && password.length() >= 6 && password.length() <= 20;
    }

    /**
     * 手机号脱敏
     *
     * @param phone 手机号
     * @return 脱敏后的手机号
     */
    public String maskPhone(String phone) {
        if (!StringUtils.hasText(phone) || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }

    /**
     * 检查积分数量是否有效
     *
     * @param points 积分
     * @return 是否有效
     */
    public boolean isValidPoints(Integer points) {
        return points != null && points > 0 && points <= 10000;
    }

}

package com.lureclub.points;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;
import org.springframework.scheduling.annotation.EnableScheduling;

/**
 * 雷霆路亚俱乐部积分管理系统启动类
 *
 * @author system
 * @date 2025-06-19
 */
@SpringBootApplication
@EnableScheduling
public class LureClubPointsApplication extends SpringBootServletInitializer {

    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {
        return application.sources(LureClubPointsApplication.class);
    }

    public static void main(String[] args) {
        SpringApplication.run(LureClubPointsApplication.class, args);
    }

}

package com.lureclub.points;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;
import org.springframework.scheduling.annotation.EnableScheduling;

/**
 * 雷霆路亚俱乐部积分管理系统启动类
 *
 * @author system
 * @date 2025-06-19
 */
@SpringBootApplication
@EnableScheduling
public class LureClubPointsApplication extends SpringBootServletInitializer {

    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {
        return application.sources(LureClubPointsApplication.class);
    }

    public static void main(String[] args) {
        SpringApplication.run(LureClubPointsApplication.class, args);
    }

}

# 开发环境配置
server:
  port: 8080

spring:
  # 数据库配置 - 开发环境
  datasource:
    url: jdbc:mysql://localhost:3306/lureclub_points_dev?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: 123456

  # JPA配置 - 开发环境
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true

  # SQL初始化配置
  sql:
    init:
      mode: always
      data-locations: classpath:data.sql

# 日志配置 - 开发环境
logging:
  level:
    com.lureclub: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

# 文件上传路径 - 开发环境
file:
  upload:
    path: D:/uploads/lureclub/

# 生产环境配置
server:
  port: 8080

spring:
  # 数据库配置 - 生产环境
  datasource:
    url: jdbc:mysql://localhost:3306/lureclub_points?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:lureclub}
    password: ${DB_PASSWORD:your_password}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 600000
      max-lifetime: 1800000

  # JPA配置 - 生产环境
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: false

  # SQL初始化配置
  sql:
    init:
      mode: never

# 日志配置 - 生产环境
logging:
  level:
    com.lureclub: INFO
    org.springframework.security: WARN
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /var/log/lureclub/application.log

# 文件上传路径 - 生产环境
file:
  upload:
    path: /data/uploads/lureclub/

# JWT配置 - 生产环境使用环境变量
jwt:
  secret: ${JWT_SECRET:your_super_secret_jwt_key_for_production}
  expiration: 86400000


数据库初始化：
-- 初始化管理员数据
-- 默认管理员账号：admin，密码：admin123
INSERT IGNORE INTO admins (id, username, password, real_name, is_enabled, create_time, update_time, is_deleted)
VALUES (1, 'admin', '$2a$10$N.oKZr.5OmGtEr.jO0aMr.YHKGy7TrEr.tH8QMgQ5Ib5xFwUy0xHu', '系统管理员', 1, NOW(), NOW(), 0);

-- 初始化一些示例公告
INSERT IGNORE INTO announcements (id, title, content, publish_date, is_top, create_time, update_time, is_deleted)
VALUES
(1, '欢迎来到雷霆路亚俱乐部', '欢迎各位钓友加入雷霆路亚俱乐部！在这里您可以体验专业的路亚钓鱼，获得积分奖励，参与排行榜竞赛。', CURDATE(), 1, NOW(), NOW(), 0),
(2, '积分系统使用说明', '积分系统说明：当日获得的积分将在次日转为有效积分，有效积分可用于抵扣门票费用。1积分=1元。', CURDATE(), 1, NOW(), NOW(), 0),
(3, '钓场开放时间调整', '自本月起，钓场开放时间调整为：周一至周日 06:00-18:00，请各位钓友合理安排时间。', CURDATE(), 0, NOW(), NOW(), 0);

-- 初始化一些示例奖品
INSERT IGNORE INTO prizes (id, name, description, image_url, sort_order, is_enabled, create_time, update_time, is_deleted)
VALUES
(1, '专业路亚竿', '高品质碳素路亚竿，长度2.1米，适合各种路亚钓法，手感轻便，灵敏度高。', '/uploads/prizes/lure_rod.jpg', 1, 1, NOW(), NOW(), 0),
(2, '路亚饵套装', '包含各种颜色和类型的路亚饵，适合不同水域和鱼种，让您的钓鱼之旅更加丰富。', '/uploads/prizes/lure_baits.jpg', 2, 1, NOW(), NOW(), 0),
(3, '专业钓箱', '多功能钓箱，内含多个储物格，可存放路亚饵、工具等，是路亚钓手的必备装备。', '/uploads/prizes/tackle_box.jpg', 3, 1, NOW(), NOW(), 0),
(4, '防晒钓鱼服', '专业防晒钓鱼服，UPF50+防护，透气舒适，是户外钓鱼的最佳选择。', '/uploads/prizes/fishing_shirt.jpg', 4, 1, NOW(), NOW(), 0);